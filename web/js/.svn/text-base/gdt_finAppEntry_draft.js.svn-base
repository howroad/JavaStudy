// 融资申请页面 --> 添加/查看/修改
var tr;
$(function(){
	var m = document.getElementById('m').value;
	
	//动态显示授信品种
	var pageCode = $("input[id='pageCode']").val();
	var bussClass = document.getElementById(pageCode + '_info.bussClass');
	var bussVariety = document.getElementById(pageCode + '_info.bussVariety');
	if(bussClass != undefined && bussClass.length <=1){
		getBussClass();
	}
	bussClass.value="CLMS02";
	bussVariety.value="CLMS10";
	if(m=='a')queryBussVariety(bussClass,bussVariety);
	$("select[id$=.bussVariety]").val("CLMS10");
	//m=v模式下显示申请日志
	var div = document.getElementById('div.gdt_log');
	div.style.display = 'none';
	if(m!=null&&m=='v'){
		div.style.display = '';
		$("font").text("");
		$('[id$="serch"]:visible').each(function(){
            $(this).hide();
        });
	}
	
	//实现删除附件,页面不刷新   
	var tab = $("input[id='"+pageCode+"_info._applyFiles_del']").prev();
	var tBody = tab.find('tbody');
	//获取tBody下面所有的子节点
	tBody.children().each(function(){
		//获取每个tr下的 第二个 td
		var tdObj = $(this).children('td').eq(1);
		//获取每个tr下的 第二个 td 下 的第二个 a 标签
		var aObj = tdObj.children('a').eq(1);
		var href = $(aObj).attr("href");
		//重置href属性,不让页面跳转
		$(aObj).attr("href","javascript:void(0)");
		//添加点解事件
		aObj.click(function(){
			$.ajax({
				type: 'POST',
				url: href,
				async : false,
				dataType: "text",
				success: function(data) {
					//删除成功,删除这一行 tr
					$(aObj).parent().parent().remove();
				}
		  	});  
		});
	})
});

//保存按钮(承兑汇票融资申请执行)
function doEntrySave(obj){
	$("[id$=.isApprove]").val("0");
	if(!saveCheck()){
		return ;
	}
	//附件验证
	if(!attachUploadValidate()){
		return;
	}
	if (!checkFileUploadControl("001")) {
		return;
	}
	smartForm_doSave(obj);
}

//提交按钮
function doEntrySubmit(obj){
	$("[id$=.isApprove]").val("1");
	if(!saveCheck()){
		return ;
	}
	//附件验证
	if(!attachUploadValidate()){
		return;
	}
	if (!checkFileUploadControl("001")) {
		return;
	}
	smartForm_doSave(obj);
}

// 提交/保存  之前先进行校验
function saveCheck(){
	var pageCode = $("input[id='pageCode']").val();
	var bussVariety = document.getElementById(pageCode + '_info.bussVariety').value;
	//add by ly start
	//校验票据信息
	var bill = $("table[id^=gdt][id$=_bill]").find("tbody tr:visible");
	if(bill.length == 0){
		if(bussVariety == "CLMS10"){
			alert("请录入票据信息!");
			return false;
		}
	}
	//add by ly end
	if(!doCheckBankIsNull(bussVariety)){
		alert("合作金融网点不存在！");
		return false;
	}
	
	var startDate = $('input[id$=.startDate]').val();
	var endDate = $('input[id$=.endDate]').val();
	//校验日期
	if(!compareDate(startDate, endDate, '出票日期不能晚于到期日')){
		return false;
	}
	
	//校验合同金额是否存在
	//校验合同金额数据是否存在
	var amount = $("input[id$='_info.amount']").val();
	if(!amount){
		alert("合同金额不能为空!")
		return false
	}
	
	/*var amtArray = $("input[id$='_bill.billAmount']");
    if(!amtArray || amtArray.length < 2){
        alert("票据信息不能为空!");
        return false;
    }*/
	
	//校验融资合同 与 担保合同 大行是否相同
	//TA0640取消校验 by 20180719
//	if(!doCheckBank()){
//		alert("融资合同所属大行与授信合同所属大行不一致");
//		return false;
//	}
	//授信字段选择了“是”，必须选择授信合同
	if(!checkIsTakeCredit()){
		return false;
	}
	//担保字段选择了“是”，必须选择担保合同
	if(!checkIsTakeGuarantee()){
		return false;
	}
	var files = $('input[id$=applyFiles_filetext]');
	if(!validateFileForamtBatch(files)){
		alert("系统不允许上传可执行格式的文件");
		return false;
	}
	return true;
}
function doCheckBank(){
	var flag = true;
	//         gdt_financeApplyEntry_credit.assBankId
	var creditBankId = $('input[id$=_credit.assBankId]').val();
	if(creditBankId == ''){
		try {
			creditBankId = $('input[id$=_credit.assBankId]')[1].value; 
		} catch (e) {}
	}
	var assBankId = $('input[id$=_info.assBankId]').val();
	if(assBankId!= undefined && assBankId != '' && assBankId != null
			&& creditBankId!= undefined && creditBankId != '' && creditBankId != null){
		var state = checkConAndCreditBank(assBankId,creditBankId);
		if(state == "false"){
			flag = false;
		}
	}
	return flag;
}

//清空数据
/*function emptyData(){
	//清空授信数据
	$("table[id=gdt_financeApplyEntry_credit]").find("tbody tr:visible").remove();
	//显示授信div
	$("div[id='div.gdt_financeApplyEntry_credit']").show();
}*/

//异步加载业务品种
function queryBussVariety(obj,obj2){
	var bussClass = obj.value;
	var bussVariety = obj2.value
	
	//删除数据
	//emptyData();
	
	//如果业务分类为空,控制业务品种为空.
	if(bussClass == ''){
		var bussVar = $("[id$=bussVariety]")[0];
		bussVar.innerHTML = "";
		bussVar[0] = new Option("", "");
		return;
	}
	
	$.ajax({
		  type: 'POST',
		  url: "GDEBIT@QueryBussVaresBusiness.sf",
		  async : false,
		  data: {'bussClass':bussClass},
		  dataType:'json',
		  success: function(data) {
			  var bussVar = $("[id$=bussVariety]")[0];
			  bussVar.innerHTML = "";
			  bussVar[0] = new Option("", "");
			  if (data.length > 0) {
				  for ( var i = 0; i < data.length; i++) {
					  var name = data[i].name;
					  var value = data[i].value;
					  bussVar[i+1] = new Option(name, value);
					  if(data[i].value == bussVariety && data[i].value !="" ){
						 bussVar.value =  bussVariety;
					  }
				  }
			  } else {
				  bussVar = new Option("", "");
			  }
		  },
		  error:function(){
			  alert("业务繁忙!");
		  }
	})
}

function getBussClass(){
	$.ajax({
		  type: 'POST',
		  url: "GDEBIT@QueryBussClassBusiness.sf",
		  async : false,
		  dataType:'json',
		  success: function(data) {
			  var bussClass = $("select[id$=.bussClass]")[0];
			  bussClass[0] = new Option("","");
			  if (data.length > 0) {
				  for ( var i = 1; i < data.length+1; i++) {
					  var name = data[i-1].name;
					  var value = data[i-1].value;
					  bussClass[i] = new Option(name, value);
				  }
			  } 
		  }
	})
}

//点击确定操作
function smartForm_confirm(msg){
	var m = document.getElementById('m').value;
	var objbut = top.Layer.getWin().document.getElementById("gdt_financeApply_qry.refresh");
	if(objbut){
		objbut.click();
	}
	if(m=='e'){
		alert(msg);
		windowClose();
	}else if (confirm(msg)){
		windowClose();
	}
}
function smartForm_confirm_false(){
	window.location.reload("GDEBIT@gdt_discfinanceApplyEntry.sf?m=a");
}



//选择金融合作网点
function selectAssBank(obj){
	var url = "GDEBIT@gdt_associateBankSlt.sf?";
	openwin(url, '金融合作网点列表', 900, 600);
}
function selectBpBank(){
	tr = $(obj).closest("tr");
	
}
//选择 -- 金融合作网点
var lastBankNo = "";
function setAssBank(obj){
	if(lastBankNo == "")lastBankNo = $("input[id$='_info.bankNo']").val();
	if(lastBankNo == "")lastBankNo = obj.bankNo;
	var assBankId= obj.assBankId;
    var assBankName= obj.assBankName;
    var bankNo = obj.bankNo;
	if(tr){
		tr.find("input[id$='_bill.recBank']").val(assBankName);
	}else{
    	$("input[id$='_info.assBankId']").val(assBankId);
    	$("input[id$='_info.assBankName']").val(assBankName);
    	//切换合作金融网点大行，清空授信担保信息
		if(lastBankNo !=bankNo){
			emptyData();
			try {
          emptyAccount();
        } catch (e) {}
			lastBankNo = bankNo;
		}
	}
}

//重置
function doReSet(obj){
	var pageCode = $("input[id$=pageCode]").val();
	var applyId = $("input[id$=_info.applyId]").val(); 
	
	var m = document.getElementById('m').value;
	var url = "GDEBIT@"+pageCode+".sf?m="+m+"&applyId="+applyId;
	location.href = url;
}
//校验利率
function checkRate(obj){
	var rate = parseFloat(obj.value.excludeNotNumericDot());
	var alt = obj.alt;
	if(rate){
		if(rate < 0){
			alert(alt + "不能为负数");
			obj.value = "";	
			return;
		}
		if(rate > 100.0){
			alert(alt + "不能超过100");
			obj.value = "";
		}
	}
}
