$(function(){
	initTitle();
	dealShowName();
	dealTotal();
	getPieData();
});

/** 加载饼状图数据 */
function getPieData() {
	var tab = $("#gdt_selectDirectFinancing_qry");
	var bussVariety = tab.find("select[id$='bussVariety']").val(); //融资品种
	var financingDate = tab.find("input[id$='financingDate']").val(); //日期
	var financingCurrency = tab.find("select[id$='financingCurrency']").val(); //币种
	var moneyUnit = tab.find("select[id$='moneyUnit']").val(); //金额单位
	$.ajax({
		type: 'post',
		async: true,
	    url: 'GDEBIT@AjaxGdebitDirectFinancing.sf',
	    data: {
	    	bussVariety: bussVariety,
	    	financingDate: financingDate,
	    	financingCurrency: financingCurrency,
	    	moneyUnit: moneyUnit
	    },
	    dataType: 'json', //返回数据形式为json
	    success: function(data) {
	        if (data) {
	            //把result(即Json数据)以参数形式放入Echarts代码中
	        	initPie(data,moneyUnit);
	        }
	    },
	    error: function(errorMsg) {
	        alert("加载数据失败");
	    }
	}); 
}

/** 饼状图初始化 */
function initPie(data) {
	var div = document.getElementById('gdt_bondPie.content');
	div.innerHTML = '<div id="mainBar" style="width:100%;height:300px;"></div>';
	var myBarChart = echarts.init(document.getElementById('mainBar'));
	option = {
		    title : {
		        text: '融资结构',
		        subtext: '',
		        x:'center'
		    },
		    tooltip : {
		        trigger: 'item',
		        formatter: function(params) {
		        	return getToolFormatter(params);
		        }
		    },
		    color:['#00B0F0', '#CD3700'],
		    legend: {
		        orient: 'vertical',
		        left: 'left',
		        data: (function(){
	                    var res = [];
                        for(var i = 0;i < data.length; i++) {
                        	res.push(data[i].name);
                        }
						return res;
					  })()
			},
			label: {
				position: 'inner'
			},
		    series : [
		        {
		            name: '融资来源',
		            type: 'pie',
		            radius : '70%',
		            center: ['50%', '60%'],
		            data: (function(){
		                    var res = [];
	                        for(var i = 0;i < data.length; i++) {
	                        	res.push({
	                        		 name: data[i].name,
	                        		 value: data[i].value
	                        	});
	                        }
	                        return res;
	                	  })(),
		            itemStyle: {
		                emphasis: {
		                    shadowBlur: 10,
		                    shadowOffsetX: 0,
		                    shadowColor: 'rgba(0, 0, 0, 0.5)'
		                }
		            }
		        }
		    ]
		};
	myBarChart.setOption(option);
}

/** 格式化饼图悬浮展示 */
function getToolFormatter(params) {
	return params.seriesName+" <br/>"+params.name+" : "+FormatMoney(params.value,2)+" ("+params.percent.toFixed(2)+"%)";
}

/** 初始化表头 */
function initTitle() {
	//获取查询条件中的日期
	var tab = $("#gdt_selectDirectFinancing_qry");
	var financingDate = tab.find("input[id$='financingDate']").val(); //日期
	var year = new Date().getFullYear();
	if(financingDate != "" || financingDate != null) {
		year = financingDate.split("-")[0];
	}
	year -= 5;
	//获取表头table
	var title_year = year;
	var title_tab = $("div[id^='gdt_selectDirectFinancing_list'] div[id='div_title'] table");
	var title_span = title_tab.find("thead span");
	title_span.each(function() {
		$(this).html(title_year+"年");
		title_year++;
	});
	//获取数据table
	var tab = $("table[id='gdt_selectDirectFinancing_list']");
	var span = tab.find("thead span");
	span.each(function (){
		$(this).html(year+"年");
		year++;
	});
}

/** 处理数据表格展示名称 */
function dealShowName() {
	var tab = $("table[id='gdt_selectDirectFinancing_list']");
	var bussClasses = tab.find("tr input[id$='bussClass']");
	bussClasses.each(function() {
		var bussClass = $(this).val();
		var tr = $(this).parents("tr:first");
		var span = tr.find("input[id$='showName']").parents("span:first");
		if(bussClass == "") {
			span.css("font-weight","bold");
		} else {
			var htm = span.html();
			span.html("&nbsp;&nbsp;&nbsp;&nbsp;"+htm);
		}
	});
}

/** 处理合计 */
function dealTotal() {
	var tab = $("table[id='gdt_selectDirectFinancing_list']");
	var bussClasses = tab.find("tr input[id$='bussClass']");
	var first = 0;
	var secend = 0;
	var third = 0;
	var fourth = 0;
	var fifth = 0;
	var sixth = 0;
	bussClasses.each(function() {
		var bussClass = $(this).val();
		if(bussClass == "") {
			var tr = $(this).parents("tr:first");
			var id = tr.attr("id");
			if(id == "") {
				first += parseFloat(tr.find("input[id$='first']").val().replace(/,/g,''));
				secend += parseFloat(tr.find("input[id$='secend']").val().replace(/,/g,''));
				third += parseFloat(tr.find("input[id$='third']").val().replace(/,/g,''));
				fourth += parseFloat(tr.find("input[id$='fourth']").val().replace(/,/g,''));
				fifth += parseFloat(tr.find("input[id$='fifth']").val().replace(/,/g,''));
				sixth += parseFloat(tr.find("input[id$='sixth']").val().replace(/,/g,''));
			}
		}
	});
	var tr = tab.find("tr[id='tableTotal_gdt_selectDirectFinancing_list']");
	var first_td = tr.find("td[id$='first.total']");
	var secend_td = tr.find("td[id$='secend.total']");
	var third_td = tr.find("td[id$='third.total']");
	var fourth_td = tr.find("td[id$='fourth.total']");
	var fifth_td = tr.find("td[id$='fifth.total']");
	var sixth_td = tr.find("td[id$='sixth.total']");
	
	first = FormatMoney(first,2);
	secend = FormatMoney(secend,2);
	third = FormatMoney(third,2);
	fourth = FormatMoney(fourth,2);
	fifth = FormatMoney(fifth,2);
	sixth = FormatMoney(sixth,2);
	
	first_td.attr("val",first);
	first_td.text(first);
	secend_td.attr("val",secend);
	secend_td.text(secend);
	third_td.attr("val",third);
	third_td.text(third);
	fourth_td.attr("val",fourth);
	fourth_td.text(fourth);
	fifth_td.attr("val",fifth);
	fifth_td.text(fifth);
	sixth_td.attr("val",sixth);
	sixth_td.text(sixth);
	
}

/** 刷新 */
function doRefresh(obj) {
	var financingDate = $("input[id$='financingDate']").val();
	if(financingDate == "" || financingDate == null) {
		alert("请输入日期！");
		return;
	}
	smartForm_doRefresh(obj);
}

