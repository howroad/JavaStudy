// 初始化
$(function(){
	//m=v模式下显示申请日志
	var div = $("div[id$='_log']")[0];
	if(div != undefined && div != null){
		div.style.display = 'none';
	}
	var m = document.getElementById('m').value;
	if(m!=null && m=='v' && div != undefined && div != null){
		div.style.display = '';
	}
	//保存后加载页面上的业务分类
	var bussClass = $("select[id$=_form.bussClass]");
	if(bussClass != undefined && bussClass.val() === null){
		getBussClass();
	}
	//实现删除附件,页面不刷新   
	var pageCode = $("input[id='pageCode']").val();
	var tab = $("input[id='"+pageCode+"_info._applyFiles_del']").prev();
	var tBody = tab.find('tbody');
	//获取tBody下面所有的子节点
	tBody.children().each(function(){
		//获取每个tr下的 第二个 td
		var tdObj = $(this).children('td').eq(1);
		//获取每个tr下的 第二个 td 下 的第二个 a 标签
		var aObj = tdObj.children('a').eq(1);
		var href = $(aObj).attr("href");
		//重置href属性,不让页面跳转
		$(aObj).attr("href","javascript:void(0)");
		//添加点解事件
		aObj.click(function(){
			$.ajax({
				type: 'POST',
				url: href,
				async : false,
				dataType: "text",
				success: function(data) {
					//删除成功,删除这一行 tr
					$(aObj).parent().parent().remove();
				}
		  	});  
		});
	})
	$("[id^='div.gdt_initialContract']").parent().attr("style","height:auto;");
});

//查询操作
function doQuery(obj){
	var minAmount = $('input[id$=.minAmount]').val();
	var maxAmount = $('input[id$=.maxAmount]').val();
	if(!compareAmount(minAmount, maxAmount, '合同金额范围不合理')){
		return;
	} 
	smartForm_doRefresh(obj)
}

//全选
function checkAll(obj){
	smartForm_all_checkbox(obj,'gdt_contract_list._check');
	getCheckSize();
}
//获取选中的行
function getCheckNum(){
	var checkObj = $("[id$=._check]:visible");
	var checkNum = 0;
	for ( var i = 0; i < checkObj.length; i++) {
		if (checkObj[i].checked) {
			checkNum++;
		}
	}
	return checkNum;
}
//选择某一个
function checkRec(obj){
	nstc.sf.clickCheckbox(obj);
	getCheckSize();
}
function getCheckSize(){
	var selectRecords = $("[id$=selectRecords]").val();
	var checkNum=getCheckNum();
	var selectRecordsHtml  = '<input id="selectRecords" name="selectRecords" type="hidden" value="'+selectRecords+'"/>'
	$("[id$=selectRecords]").parent().html("共计"+selectRecords+"笔，已选"+checkNum+"笔。"+selectRecordsHtml);
}

//点击确定操作
function smartForm_confirm(msg){
	var nstc_id= top.Layer.getWin().NSTC_LAYER_ID;
	//var objbtn = $("[id$='gdt_contract_qry.refresh']")[0];
	var isApprove = $("[id$=.isApprove]").val();
	if(isApprove==1){
		alert(msg);
		var objbtn = top.Layer.getWin().document.getElementById("gdt_contract_qry.refresh");
		/*add by nj for 如果没找到主页面的刷新对象，就找内源页面的刷新对象 start*/
		if(objbtn==null||objbtn==undefined){
			objbtn = top.Layer.getWin().document.getElementById("gdt_intSource_qry.refresh");
		}
		/*add by nj for 如果没找到主页面的刷新对象，就找内源页面的刷新对象 end*/
		if(objbtn){
			objbtn.click();
			}
		windowClose();
	}else{
		var m = document.getElementById('m').value;
		/*var objbtn = top.Layer.getWin().document.getElementById("gdt_contract_qry.refresh");
		if(objbtn){
			objbtn.click();
		}*/
		setTimeout(function(){
			top.Layer.getWin().NSTC_LAYER_ID = nstc_id;
		},2000);
		if(m=='e'){
			if(confirm(msg)){
				//合同的刷新
				var objbtn = top.Layer.getWin().document.getElementById("gdt_contract_qry.refresh");
				if(objbtn){
					objbtn.click();
				windowClose();
				}else{
					//内源的刷新
					var objbtn = top.Layer.getWin().document.getElementById("gdt_intSource_qry.refresh");
					if(objbtn){
						objbtn.click();
					windowClose();
					}
				}
			}else{
				var pageCode = $("input[id$='pageCode']").val();
				var applyId = $("input[id$='applyId']").val();
				var fmId = $("input[id$='fmId']").val();
				var variety = $("input[id$='bussVariety']").val();
				var url='';
				/*var isApply = ''
					$("input[id$='guaranteeType']").each(function() {
						var tr = $(this).parents("tr").first();
						var type = this.value;
						isApply = tr.find("input[name$='isApply']")[0].value;
					});*/
				if(fmId!=undefined&&fmId!=''){
					//url = "GDEBIT@"+pageCode+".sf?m=a"+"&isApply=1"+"&applyId="+applyId+"&fmId="+fmId;
					url = "GDEBIT@"+pageCode+".sf?m=e"+"&isApply=1"+"&fmId="+fmId+"&pageCode="+pageCode;
				}else{
					url = "GDEBIT@"+pageCode+".sf?m=e"+"&pageCode="+pageCode;
				}
			
				//window.location.reload("GDEBIT@"+pageCode+".sf?m=a");
				location.href = url;
			}
			
		} else {
			if (confirm(msg)) {
				
				var objbtn = top.Layer.getWin().document.getElementById("gdt_contract_qry.refresh");
				if(objbtn){
					objbtn.click();
					}
				windowClose();
			} else {
				var pageCode = $("input[id$='pageCode']").val();
				var applyId = $("input[id$='applyId']").val();
				var fmId = $("input[id$='fmId']").val();
				var variety = $("input[id$='bussVariety']").val();
				var isApply = ''
			/*	$("input[id$='guaranteeType']").each(function() {
					var tr = $(this).parents("tr").first();
					var type = this.value;
					isApply = tr.find("input[name$='isApply']")[0].value;
				});*/
				
				var url='';
				if(fmId!=undefined&&fmId!=''){
					//url = "GDEBIT@"+pageCode+".sf?m=a"+"&isApply="+isApply+"&applyId="+applyId+"&fmId="+fmId;
					url = "GDEBIT@"+pageCode+".sf?m=a"+"&fmId="+fmId+"&variety="+variety+"&pageCode="+pageCode;
				}else{
					url = "GDEBIT@"+pageCode+".sf?m=a"+"&variety="+variety;
				}
			
				//window.location.reload("GDEBIT@"+pageCode+".sf?m=a");
				location.href = url;
			}
		} 
	}
	
}
function smartForm_confirm_false(){
	var pageCode = $("input[id$='pageCode']").val();
	window.location.reload("GDEBIT@"+pageCode+".sf?m=a");
	var docu = top.Layer.getWin().document;
	$(docu).find("input[id$='refresh']").click();
	setTimeout(function(){
		top.Layer.getWin().NSTC_LAYER_ID = nstc_id;
	},2000);
}

//添加按钮
function doAdd(){
	var url = 'GDEBIT@gdt_conLiquidity.sf?m=a&isApply=1';
	openwin(url, '合同登记录入', 1200, 600);
}
//提交按钮(合同登记提交的工作流调用)
function doSubmit(obj){
	var checkObj = $("[id$=._check]:visible");
	var checkNum = 0;
	var fmId = new Array();
	for ( var i = 0; i < checkObj.length; i++) {
		if (checkObj[i].checked) {
			/*var modifyText = $(checkObj[i]).closest("tr").find("a[id$=.modifyText]").html();
			if(modifyText == '补录'){
				 alert("补录的合同不能参与批量提交！");
				 return;
			}*/
			checkNum++;
		}
	}
	if (checkNum == 0) {
		alert("至少选择一条记录！");
		return;
	}
	//add by ly start 
	if(!checkGuaOnSubmit(checkObj)){
		alert("担保信息不能为空！");
		return;
	}
	//add by ly end
	var form = nstc.sf.findParent(obj, "FORM");
	form.action = $('#appNo').val() + '@' + obj.id + ".sf";
	//2018-01-17 会调用gdt_contract.js中的nstc.sf.validate
	//smartForm_doSave(obj);
	form.submit();
	
}

//add by ly start 提交到工作流之前，校验担保是否占用，是否需要补录担保信息
function checkGuaOnSubmit(obj){
	var checkObj = new Array();
	checkObj = obj;
	var result = true;
	for ( var i = 0; i < checkObj.length; i++) {
		if (checkObj[i].checked) {
			var tr = $(checkObj[i]).closest("tr");
			var isTakeGuarantee = tr.find("[id$='isTakeGuarantee']").val();
			if(isTakeGuarantee == 1){//1占担保 0不占
				var fmId = tr.find("[id$='_list.fmId']").val();
				$.ajax({
					type: 'POST',
					  url: "GDEBIT@CheckGuaranteeContractNoExistBusiness.sf",
					  async : false,
					  data: {"fmId":fmId},
					  success: function(data) {
						 if(data != "true"){
							 result = false;
						 }
					  }
				});
			}
			if(result == false){
				break;
			}
		}
	}
	return result;
}
//add by ly end 

// 删除按钮
function doDelete(obj){
	var checkNum=getCheckNum();
	if (checkNum == 0) {
		alert("至少选择一条记录！");
		return;
	}
	if(confirm("确认删除？")){
		smartForm_doDelete(obj);
	}
}

//删除中介按钮
function doDelAgency(obj){
	var list = $("div[id$='_agency']");
	var checks = list.find('input[id$="_check"]:checked');
	if(checks == undefined || checks.length==0){
		alert("至少选择一条数据");
		return;
	}
	$(checks).each(function(){
		nstc.sf.delCurrRow(this)
	});
}

// 其他利率 填写检验
function checkOtherTaxRate(){
	var otherTaxRateIsChecked = true;
	$("[id$='.taxRate']").each(function(){
		if(!checkRate($(this)[0])){
			otherTaxRateIsChecked = false;
		}
	});
	return otherTaxRateIsChecked;
}

//录入提交按钮
function doEntrySubmit(obj){
	$("[id$=.isApprove]").val("1");
	var tab = document.getElementById("gdt_guarantee");
	var trs = $(tab).find('tbody tr:visible');
	for ( var int = 0; int < trs.length; int++) {
		var guaranteeId = $(trs[int]).find("input[id$='guaranteeId']").val();
		var isApply = $(trs[int]).find("input[id$='isApply']").val();
		 if(isApply==1){
			 var guaranteeNo = $(trs[int]).find("input[id$='guaranteeNo']").val(); 
				
			 if (guaranteeNo == undefined || guaranteeNo == "") {
					alert("请先进行担保合同的补录！");
					return;
				}
		 }
	}
	// 其他税率 填写检验
	if(!checkOtherTaxRate()){
		return;
	}
	//附件验证
	if(!attachUploadValidate()){
		return;
	}
	if (!checkFileUploadControl("002")) {
		return;
	}
	if(!checkDivAndDep()){
		return;
	}
	if(!checkAccbillCustomized()){
		return;
	}
	var bussVariety = $("select[id$='.bussVariety']").val();
	if(bussVariety=='CLMS02'){//债券发行
		var issueDate = $("input[id$='.issueDate']").val();
		var startDate = $("input[id$='.startDate']").val();
		if(startDate<issueDate){
			alert("开始日/起息日应晚于发行日期");
			return;
		}
	}
	
	if(bussVariety=='CLMS28'){//资产证券化
		//法定到期日
		var endDate = $("input[id$='.endDate']").val();
		//产品设立日/起息日
		var startDate = $("input[id$='.startDate']").val();
		if(startDate >= endDate){
			alert("产品设立日/起息日应早于法定到期日");
			return;
		}
	}	
	$("[id$='_form.isImportant']").removeAttr("disabled");
	$("[id$=.isLibor]").removeAttr("disabled");
	/**
	 * 因为内源的数据有设置为disabled,所以保存的时候需要去掉disabled
	 * lihongling
	 */
	$("input[type='text']:visible").removeAttr("disabled");
	$("select:visible").removeAttr("disabled");
	smartForm_doSave(obj);
}
//合同登记：录入保存按钮
function doEntrySave(obj){
	$("[id$=.isApprove]").val("0");
	// 其他税率 填写检验
	if(!checkOtherTaxRate()){
		return;
	}
	//附件验证
	if(!attachUploadValidate()){
		return;
	}
	if (!checkFileUploadControl("002")) {
		return;
	}
	if(!checkDivAndDep()){//校验事业部、部门
		return;
	}
	if(!checkAccbillCustomized()){
		return;
	}
	var bussVariety = $("select[id$='.bussVariety']").val();
	if(bussVariety=='CLMS02'){//债券发行
		var issueDate = $("input[id$='.issueDate']").val();
		var startDate = $("input[id$='.startDate']").val();
		if(startDate<issueDate){
			alert("开始日/起息日应晚于发行日期");
			return;
		}
	}
	if(bussVariety=='CLMS28'){//资产证券化
		//法定到期日
		var endDate = $("input[id$='.endDate']").val();
		//产品设立日/起息日
		var startDate = $("input[id$='.startDate']").val();
		if(startDate >= endDate){
			alert("产品设立日/起息日应早于法定到期日");
			return;
		}
	}
	
	$("[id$=.isLibor]").removeAttr("disabled");
	$("[id$='_form.isImportant']").removeAttr("disabled");	
	/**
	 * 因为内源的数据有设置为disabled,所以保存的时候需要去掉disabled
	 * lihongling
	 */
	$("input[type='text']:visible").removeAttr("disabled");
	$("select:visible").removeAttr("disabled");
	smartForm_doSave(obj);
}

//执行gdt_conGdtLoan.js中doEntrySave()会调用此方法
nstc.sf.validate = function(formId){
	return saveCheck();
}

//录入 授信信息删除按钮
function doDelCredit(obj){
	var list=$("div[id$='_credit']");
	//var checks=list.find("input[id$='_check']:checked");
	var checks=$("input[id$='_credit._check']:checked");
	if(checks==undefined || checks.length==0){
		alert("至少选择一条数据");
		return;
	}
	$(checks).each(function(){
		nstc.sf.delCurrRow(this)
	});
}

//录入 合同金额删除按钮
function doDelAmount(obj){
	var list=$('div[id$="_amount"]');
	var checks=list.find('input[id$="_check"]:checked');
	if(checks==undefined || checks.length==0){
		alert("至少选择一条数据");
		return;
	}
	$(checks).each(function(){
		nstc.sf.delCurrRow(this)
	});
}
//录入 费用信息删除按钮
function doDelFees(obj){
	var list=$('div[id$="_fees"]');
	var checks=list.find('input[id$="_check"]:checked');
	if(checks==undefined || checks.length==0){
		alert("至少选择一条数据");
		return;
	}
	$(checks).each(function(){
		nstc.sf.delCurrRow(this)
	});
}
//录入出资方信息删除按钮
function doDelInvestor(obj){
	var list=$('div[id$="_investor"]');
	var checks=list.find('input[id$="_check"]:checked');
	if(checks==undefined || checks.length==0){
		alert("至少选择一条数据");
		return;
	}
	$(checks).each(function(){
		nstc.sf.delCurrRow(this)
	});
}
//录入标的物信息删除按钮
function doDelProject(obj){
	var list=$('div[id$="_project"]');
	var checks=list.find('input[id$="_check"]:checked');
	if(checks==undefined || checks.length==0){
		alert("至少选择一条数据");
		return;
	}
	$(checks).each(function(){
		nstc.sf.delCurrRow(this)
	});
}
//录入 票据信息删除按钮
function doDelBill(obj){
	var list=$('div[id$="_bill"]');
	var checks=list.find('input[id$="_check"]:checked');
	if(checks==undefined || checks.length==0){
		alert("至少选择一条数据");
		return;
	}
	$(checks).each(function(){
		nstc.sf.delCurrRow(this)
	});
}

//选择金融合作网点
function selectAssBank(obj){
	var tr = nstc.sf.findParent(obj, 'tr');
	var rowIndex = tr.rowIndex - 1;
	var url = "GDEBIT@gdt_associateBankSlt.sf?rowIndex="+rowIndex;
	openwin(url, '金融合作网点列表', 900, 500);
}

//选择境外金融合作网点
function selectOutAssBank(obj){
	var tr = nstc.sf.findParent(obj, 'tr');
	var rowIndex = tr.rowIndex - 1;
	var url = "GDEBIT@gdt_assOutBankSlt.sf";
	openwin(url, '金融合作网点列表', 500, 400);
}

//选择 -- 境外金融合作网点
function setAssOutBank(obj){
	var assBankId= obj.assBankId;
	var assBankName= obj.assBankName;
	
	$("input[id$='_info.overseasBank']").val(assBankId);
	$("input[id$='_info.overseasBankName']").val(assBankName);
}

//选择 -- 金融合作网点
var lastBankNo = "";
function setAssBank(obj){
	var rowIndex = obj.rowIndex;
	var assBankId= obj.assBankId;
	var assBankName= obj.assBankName;
	var bankNo = obj.bankNo;
	var bankName = obj.bankName;
	
	/*if (obj.flag == '1') {
		//交易项[承销机构]获取合作金融网点
		$("input[id='gdt_underwrite.bankname']")[rowIndex].value = assBankName;
		$("input[id='gdt_underwrite.bankno']")[rowIndex].value = bankNo;
		$("input[id='gdt_underwrite.assBankId']")[rowIndex].value = assBankId;
	} else if (obj.flag == '2') {
		//交易项[中介机构]获取合作金融网点
		$("input[id='gdt_agency.bankname']")[rowIndex].value = assBankName;
		$("input[id='gdt_agency.bankno']")[rowIndex].value = bankNo;
	} else */
	if (obj.flag == '3') {
		//交易项[出资方]获取合作金融网点
		$("input[id='gdt_investor.investorName']")[rowIndex].value = assBankName;
		$("input[id='gdt_investor.assBankId']")[rowIndex].value = assBankId;
	} else if (obj.flag == '4') {
		$("input[id$='Bond_investor.assBankId']")[rowIndex].value = assBankId;
		$("input[id$='Bond_investor.assBankName']")[rowIndex].value = assBankName;
	}else {
		//融资申请获取合作金融网点
		if(lastBankNo == "")lastBankNo = $("input[id$='_info.bankNo']").val();
		if(lastBankNo == "")lastBankNo = obj.bankNo;
		$("input[id$='_info.bankName']").val(bankName);
		var flag = checkBankAndCur(obj);
		if(!flag){
			try {
				$("input[id$='_amount.assBankId']")[rowIndex].value=assBankId;
				$("input[id$='_amount.assBankName']")[rowIndex].value=assBankName;
				$("input[id$='_amount.bankNo']")[rowIndex].value=bankNo;
			} catch (e) {
				$("input[id$='_info.assBankId']").val(assBankId);
				$("input[id$='_info.assBankName']").val(assBankName);
				$("input[id$='_info.bankNo']").val(bankNo);
				//切换合作金融网点大行，清空授信担保信息
				if(lastBankNo !=bankNo){
					try {
						emptyGuarantee();
					} catch (e) {}
					
					try {
						emptyCredit();
					} catch (e) {}
					try {
						emptyAccount()
					} catch (e) {}
					lastBankNo = bankNo;
				}
			}
			
			//查询利率
			queryLoanRateForChangeKind();
		}
	}
}

//校验占比
function checkOccupy(obj){
	var tr = nstc.sf.findParent(obj, "TR");
	var occupy = $(tr).find("input[id$='_amount.occupyProportion']").val();
	
	var rate2 = $(obj);
	if(occupy !='' && occupy != null && occupy != undefined){
		//rate2.val().excludeNotNumericDot()
		if(100.0 - parseFloat(occupy)<0){
			alert("占比不能超过100");
			$(tr).find("input[id$='_amount.occupyProportion']").val('');
			return;
		}
	}
}
//校验同一家大银行币种是否重复
function checkBankAndCur(obj){
	var rowIndex = obj.rowIndex;
	var page = $("input[id$='pageCode']").val();
	var bussVariety = obj.bussVariety;
	if(bussVariety == undefined) bussVariety = $("select[id$='_form.bussVariety']").val();
	if(bussVariety == undefined) bussVariety = $("input[id$='_form.bussVariety']").val();
	var flag = true;
	
	//银团
	if(bussVariety == "CLMS07"){
		flag = false;
		/*
		//选择币种
		if(rowIndex == undefined ){
			var temp = '';
			var tr = nstc.sf.findParent(obj, "TR");
			rowIndex = tr.rowIndex - 1; 
			$("input[id$='_amount.assBankName']").each(function(){
				var tr = nstc.sf.findParent(this, 'tr');
				var currencyNo = $(tr).find('select[id$=_amount.currencyNo]').val();
				var assBankId = $(tr).find('input[id$=_amount.assBankId]').val();
				if(assBankId == undefined || assBankId == '' || currencyNo == undefined || currencyNo == ''){
					flag = false;
				}else{
					var bankCode = queryParentNo(assBankId);
					var str = "^"+bankCode+"-"+currencyNo+"^";
					var index = temp.indexOf(str);
					if(index == -1){
						temp = temp + str + ",";
						flag = false;
					}else{
						alert("同一大行,不能选择同一币种!");
						$('select[id$=_amount.currencyNo]')[rowIndex].value='';
						flag = true;
						return;		 
					} 
				}
			})
			
		}else{
			//选择银行
			var temp = '';
			$("input[id$='_amount.assBankName']").each(function(){
				var tr = nstc.sf.findParent(this, 'tr');
				var currencyNo = $(tr).find('select[id$=_amount.currencyNo]').val();
				var assBankId = $(tr).find('input[id$=_amount.assBankId]').val();
				
				if(tr.rowIndex -1 == rowIndex){
					var assBankId = obj.assBankId;
				}
				
				if(assBankId == undefined || assBankId == '' || currencyNo == undefined || currencyNo == ''){
					flag = false;
				}else{
					var bankCode = queryParentNo(assBankId);
					var str = "^"+bankCode+"-"+currencyNo+"^";
					var index = temp.indexOf(str);
					if(index == -1){
						temp = temp + str + ",";
						flag = false;
					}else{
						alert("同一大行,不能选择同一币种!");
						$('input[id$=_amount.assBankName]')[rowIndex].value='';
						$('input[id$=_amount.assBankId]')[rowIndex].value='';
						flag = true;
						return;		 
					} 
				}
			})
		}
		*/
	} else {
		//非多币种
		var temp = '';
		//有amount列表单元
		var list = $("select[id$='_amount.currencyNo']");
		//if(bussVariety == 'CLMS05' || bussVariety == 'CLMS06'){
		if (list.length > 1) {
			$("select[id$='_amount.currencyNo']").each(function(){
				var tr = nstc.sf.findParent(this, 'tr');
				var currencyNo = $(tr).find('select[id$=_amount.currencyNo]').val();
				if(currencyNo != ''){
					var str = "^"+currencyNo+"^";
					var index = temp.indexOf(str);
					if(index == -1){
						temp = temp + str + ",";
						flag = false;
					} else {
						alert("同一大行,不能选择同一币种!");
						$(nstc.sf.findParent(obj, 'tr')).find('select[id$=_amount.currencyNo]').val("");
						flag = true;
						return;		 
					}
				} else {
					flag = false;
				}
			});
		} else {
			flag = false;
		}
	}
	return flag;
}

//控制利率浮动方式输入框展示
/*function showFloatVal(obj){
	
	var temp = $("select[id$=_amount.floatType]").val();
	if(temp == undefined){
		// info
		//获取浮动方式
		var tr = nstc.sf.findParent(obj, "TR");
		var floatType = obj.value;
		var floatValueObj = $(tr).find('input[id$=.floatValue]')[0];
		var floatValue = $(tr).find('input[id$=.floatValue]').val();
		var baseRate = $("input[id$='_info.baseRate']").val();
		if(floatType == undefined || floatType == ""){
			alert("利率浮动方式不能为空!");
		}else if(floatType == '2'){
			//隐藏输入框	
			$(floatValueObj).hide();
			floatValueObj.value = '';
		}else{
			//显示输入框
			$(floatValueObj).show(); 
		}
		var rate = countRate(baseRate,floatType,floatValue);
		
		if(parseFloat(rate) < parseFloat(0.0)){
			rate = '';
			alert("利率值不合法!利率小于0");
		}
		if(parseFloat(rate) > parseFloat(100.0)){
			rate = '';
			alert("利率值不合法!利率大于100");
		}
		
		$('input[id$=.rate]').val(rate)
	}else{
		//amount
		//获取浮动方式
		var tr = nstc.sf.findParent(obj, "TR");
		var floatType = obj.value;
		var floatValueObj = $(tr).find('input[id$=.floatValue]')[0];
		var floatValue = $(tr).find('input[id$=.floatValue]').val();
		var baseRate = $(tr).find('input[id$=.baseRate]').val();
		if(floatType == undefined || floatType == ""){
			alert("利率浮动方式不能为空!");
		}else if(floatType == '2'){
			//隐藏输入框	
			$(floatValueObj).hide();
			floatValueObj.value = '';
		}else{
			//显示输入框
			$(floatValueObj).show(); 
		}
		var rate = countRate(baseRate,floatType,floatValue);
		
		if(parseFloat(rate) < parseFloat(0.0)){
			rate = '';
			alert("利率值不合法!利率小于0");
		}
		if(parseFloat(rate) > parseFloat(100.0)){
			rate = '';
			alert("利率值不合法!利率大于100");
		}
		
		$(tr).find('input[id$=.rate]').val(rate)
	}
}*/


//选择合同录入,选择申请单号方式,隐藏业务品种和分类,只显示值
function doHidden(bussClass,bussVariety){
	
	//var pageCode = $("input[id$='pageCode']").val();
	//var pageCode = "gdt_common";
	
	var idVal = $("input[id$='_form.isImportant']").attr("id");
	var pageCode = idVal.replace(/_form.isImportant/,"");
	bussClass.hide();
	bussVariety.hide();
	bussClass.parent().html("<span>"+bussClass.find('option:selected').text()+"</span>" +
			"<input id='"+pageCode+"_form.bussClass' name='"+pageCode+
			"_form.bussClass' type='hidden' value='"+bussClass.val()+"' />"); 
	bussVariety.parent().html("<span>"+bussVariety.find('option:selected').text()+"</span>"+
			"<input id='"+pageCode+"_form.bussVariety' name='"+pageCode+
			"_form.bussVariety' type='hidden' value='"+bussVariety.val()+"' />"); 
}

function doHiddenSelect(obj, str){
	var pageCode = $("input[id$='pageCode']").val();
	obj.hide();
	obj.parent().html("<span>"+obj.find('option:selected').text()+"</span>"+
	"<input id='" + pageCode + "_info." + str + "' name='" + pageCode+
	"_info." + str + "' type='hidden' value='"+obj.val()+"' />"); 
}

//选择申请,设置单位不能点击
function doHiddenApply(clt){
	clt.hide();
	clt.parent("span").html(clt.val());
}

//展示 申请单
function showApply(obj){
	var url = "GDEBIT@gdt_select_apply.sf";
	openwin(url, '申请列表', 1000,600);
}

//查看操作
function look(obj){
	var tr = nstc.sf.findParent(obj, 'tr');
	var fmId = $(tr).find('input[id$=.fmId]').val();
	var bussVariety = $(tr).find('input[id$=.bussVariety]').val();
	doSelContract(bussVariety,null,fmId,"v");
}
//修改操作
function update(obj){
	var tr = nstc.sf.findParent(obj, 'tr');
	var fmId = $(tr).find('input[id$=.fmId]').val();
	var bussVariety = $(tr).find('input[id$=.bussVariety]').val();
	doSelContract(bussVariety,null,fmId,"e");
}


//校验合同编号是否存在
function checkContractNo(obj){
	var contractNo = obj.value;
	if(contractNo == undefined || contractNo == null || contractNo == ""){return ;}
	//获取fmId
	var fmId = $("input[id$='fmId']").val();
	//获取副本
	var contractNoBak = $("input[id$='contractNo_bak']").val();
	
	$.ajax({
		type: 'POST',
		  url: "GDEBIT@CheckContractNoBusiness.sf",
		  async : false,
		  data: {'contractNo':contractNo,"fmId":fmId},
		  success: function(data) {
			 if(data != "true"){
				 $("input[id$='contractNo']").val(contractNoBak);
				 alert("合同编号重复!");
			 }
		  }
	});
}

//选择融资合同录入 页面
function doSelContract(variety,applyId,fmId,m){
	//获取模式
	//var m = document.getElementById('m').value;
	var url=""
	if(variety == 'CLMS01'){
		// 股票
		url="GDEBIT@gdt_conStock.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS02'){
		// 债券
		url="GDEBIT@gdt_conBond.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS03'){
		// 信托产品
		url="GDEBIT@gdt_conTrust.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS04'){
		// 其他直接融资
		url="GDEBIT@gdt_conDirOther.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS05'){
		// 流动资金贷款
		url="GDEBIT@gdt_conLiquidity.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS06'){
		//项目贷款
		url="GDEBIT@gdt_conProject.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS07'){
		//银团贷款
		url="GDEBIT@gdt_conSyndicate.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS08'){
		//委托贷款
		url="GDEBIT@gdt_conEntrust.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS09'){
		//间接融资-贷款》固定资产贷款 
		url="GDEBIT@gdt_conFixed.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS10'){
		//间接融资-贷款》承兑汇票
		url="GDEBIT@gdt_conAccbill.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS11'){
		//间接融资-贷款》票据贴现
		url="GDEBIT@gdt_conBillDisc.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}else if(variety == 'CLMS12'){
		//间接融资-贷款》内保外贷
		url="GDEBIT@gdt_conInOut.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}else if(variety == 'CLMS13'){
		//间接融资-贷款》内存外贷
		url="GDEBIT@gdt_conOutOfMemory.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS14'){
		//间接融资-贷款》其它
		url="GDEBIT@gdt_conLoanOther.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS15'){
		//间接融资-贸易融资》进口L/C开证
		url="GDEBIT@gdt_conImportLC.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS16'){
		//间接融资-贸易融资》进口T/T押汇
		url="GDEBIT@gdt_conImportTBill.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS17'){
		//间接融资-贸易融资》信用证买方押汇	
		url="GDEBIT@gdt_conImportLCBill.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}else if(variety == 'CLMS18'){
		//间接融资-贸易融资》T/T代付	
		url="GDEBIT@gdt_conTPayForAn.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS19'){
		////间接融资-贸易融资》L/C代付	
		url="GDEBIT@gdt_conLCPayForAn.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS20'){
		//间接融资-贸易融资》出口T/T押汇
		url="GDEBIT@gdt_conExportTBill.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS21'){
		//间接融资-贸易融资》出口L/C押汇		
		url="GDEBIT@gdt_conExportLCBill.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS22'){
		//间接融资-贸易融资》出口L/C打包贷款
		url="GDEBIT@gdt_conExportLCLoan.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS23'){
		//间接融资-贸易融资》保理	
		url="GDEBIT@gdt_conFactor.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}else if(variety == 'CLMS24'){
		// 贸易融资  -- 保函
		url="GDEBIT@gdt_conGuarantee.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS25'){
		//间接融资：贸易融资：其他
		url="GDEBIT@gdt_conIndOther.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS26'){
		//融资租赁 
		url="GDEBIT@gdt_conFinLease.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS28'){
		// 资产证券化
		url="GDEBIT@gdt_conAssetSecu.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS27'){
		//福费廷
		url="GDEBIT@gdt_conForfaiting.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS29'){
		// 保险
		url="GDEBIT@gdt_conInsurance.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS30'){
		// 基金
		url="GDEBIT@gdt_conFund.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&isApply=1";
	}else if(variety == 'CLMS31'){
		// 集合资管贷款
		url="GDEBIT@gdt_conAssetManage.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}else if(variety == 'CLMS32'){
		// 非金债
		url="GDEBIT@gdt_conNoGoldDebt.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}else if(variety == 'CLMS33'){
		// 信托贷款
		url="GDEBIT@gdt_conTrustLoan.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}else if(variety == 'CLMS34'){
		//间接融资-贷款》外保内贷
		url="GDEBIT@gdt_conOutIn.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}else if(variety == 'CLMS35'){
		//类保理
		url="GDEBIT@gdt_conClassFactor.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}else if(variety == 'CLMS36'){
		//产业基金
		url="GDEBIT@gdt_conIndustryFund.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}else if(variety == 'CLMS38'){
		//保险债权计划
		url="GDEBIT@gdt_conICPlan.sf?m="+m+"&applyId="+applyId+"&fmId="+fmId+"&variety="+variety+"&isApply=1";
	}
	
	if(fmId != null ){
		if(m=='e'){
			openwin(url, '合同登记修改', 1200,600);
		}else if(m=='v'){
			openwin(url, '合同登记查看', 1200,600);
		}
		return;
	}
	location.href = url;
//	controlLgmShow(variety);
}

/*function controlLgmShow(variety) {
	var bzj = $("div[id$='_lgm']")[0];
	if (variety == 'CLMS26' || variety == 'CLMS05' || variety == 'CLMS06' || 
			variety == 'CLMS07' || variety == 'CLMS08' || variety == 'CLMS09' || 
			variety == 'CLMS12' || variety == 'CLMS13' || variety == 'CLMS14') {
		if (bzj != null && bzj != '') {
			bzj.style.display = '';
		}
	} else {
		if (bzj != null && bzj != '') {
			bzj.style.display = 'none';
		}
	}
}*/

//业务品种 onchange
function doChangeBV(obj){
	
	var variety = obj.value;
	doSelContract(variety,null,null,"a");
}

//业务分类 onchange事件
function doChangeBC(obj){
	doChange(obj,'add');
	//手动调用 业务品种onchange 
	var bussVar = $("select[id$=.bussVariety]")[0];
	doChangeBV(bussVar);
}
//获取融资业务分类
function getBussClass(){
	$.ajax({
		  type: 'POST',
		  url: "GDEBIT@QueryBussClassBusiness.sf",
		  async : false,
		  dataType:'json',
		  success: function(data) {
			  var bussClass = $("select[id$=.bussClass]")[0];
			  if (data.length > 0) {
				  for ( var i = 0; i < data.length; i++) {
					  var name = data[i].name;
					  var value = data[i].value;
					  bussClass[i] = new Option(name, value);
				  }
			  } 
		  }
	})
}



//异步加载业务品种
function doChange(obj,model){
	if(obj == undefined) return;
	var bussClass = obj.value;
	$.ajax({
		  type: 'POST',
		  url: "GDEBIT@QueryBussVaresBusiness.sf",
		  async : false,
		  data: {'bussClass':bussClass,'model':model},
		  dataType:'json',
		  success: function(data) {
			  var bussVar = $("select[id$=.bussVariety]")[0];
			  bussVar.innerHTML = "";
			  if (data.length > 0) {
				  for ( var i = 0; i < data.length; i++) {
					  var name = data[i].name;
					  var value = data[i].value;
					  bussVar[i] = new Option(name, value);
				  }
			  } 
		  }
	})
}

//设置申请单号
function setApply(obj){
	var applyId = obj.applyId;
	var bussVariety = obj.bussVariety;
	doSelContract(bussVariety,applyId,null,"a");
}

//选择票据信息
function doSelAccBill(){
	var applyNo = $("input[id$=_info.cltNo]").val();
	if(applyNo == undefined || applyNo == null || applyNo == ''){
		alert("请先选择单位")
		return ;
	}
	var billIds = "";
	$("input[id$=_bill.billId]").each(function (){
		var temp = this.value;
		if(temp != undefined && temp != null && temp != ''){
			billIds = billIds+","+temp;
		}
	})
	var url="GDEBIT@gdt_select_accBill.sf?m=v&applyNo="+applyNo+"&billIds="+billIds;
	openwin(url, '选择票据页面', 800,600);
}
//选择信用证
function doSelCreditBill(){
	var applyNo = $("input[id$=_info.cltNo]").val();
	if(applyNo == undefined || applyNo == null || applyNo == ''){
		alert("请先选择单位")
		return ;
	}
	var bussVariety = $("select[id$=_form.bussVariety]").val();
	if(bussVariety == undefined)bussVariety = $("input[id$=_form.bussVariety]").val();
	var url="GDEBIT@gdt_select_LC.sf?m=v&applyNo="+applyNo+"&bussVariety="+bussVariety;
	openwin(url, '选择国际信用证页面', 800,600);
}

//选择保函
function doSelGuaBill(){
	var applyNo = $("input[id$=_info.cltNo]").val();
	if(applyNo == undefined || applyNo == null || applyNo == ''){
		alert("请先选择单位")
		return ;
	}
	var url="GDEBIT@gdt_select_LG.sf?m=v&applyNo="+applyNo;
	openwin(url, '选择保函页面', 800,600);
}


//计算期限
/*改为调用gdt_contractGua.js
function setTermDay(){
	var startDate = $('input[id$=.startDate]').val();
	var endDate = $('input[id$=.endDate]').val();
	if(!compareDate(startDate, endDate, '开始日不能晚于到期日')){
		$('input[id$=_info.endDate]').val('');
		return false;
	}
	if(startDate != '' && endDate != ''){
		var idVal = $("input[id$='_info.cltNo']").attr("id");
		var beginStr = idVal.replace(/.cltNo/,"")
		var termDay = DateCompare(startDate,endDate);
		var html  = "<input id='"+beginStr+".termDay' name='"+beginStr+".termDay' type='hidden' value='"+termDay+"'/>"
		$('input[id$=.termDay]').parent().html(termDay + "天" + html);
	}
}*/

//重置
function doReSet(obj){
	
	var pageCode = $("input[id$=pageCode]").val();
	var fmId = $("input[id$=_info.fmId]").val();
	var applyId = $("input[id$=_form.applyId]").val(); 
	
	var m = document.getElementById('m').value;
	var url = "GDEBIT@"+pageCode+".sf?m=";
	if(m == 'a'){
		if(applyId == undefined){
			url = url + m+"&fmId="+fmId+"&pageCode="+pageCode;
		}else{
			url = url + m+"&applyId="+applyId+"&pageCode="+pageCode;
		}
	}else{
		url = url + m+"&fmId="+fmId+"&pageCode="+pageCode;
	}
	location.href = url;
} 

//校验
function saveCheck(){
	$("input").removeAttr("disabled");
	var bussVariety = $("select[id$='_form.bussVariety']").val();
	if(bussVariety == undefined) bussVariety = $("input[id$='_form.bussVariety']").val();
	//校验合同金额数据是否存在
	var amount = $("input[id$='_amount.amount']");
	if(amount == undefined || amount == null){
		return true;
	}	
	if(amount.length == 1){
		alert("请录入合同金额信息!")
		return false
	}
	
	//校验占比是否合法  和为100
	if(bussVariety == 'CLMS07'){
		if(!doCheckOccupy()){
			alert("占比总和应为100");
			return false;
		}
	}
	if(bussVariety == 'CLMS28'){
		var bsn=$("[id$='gdt_product.bondShortName']");
		if(bsn.length == 1){
			alert("请录入产品信息!")
			return false
		}
	}
	
	//校验占用授信 大行 否与 合同大行 相同
	//TA0640取消校验 by 20180719
//	if(!doCheckBank(bussVariety)){
//		alert("融资合同所属大行与授信合同所属大行不一致");
//		return false;
//	}
	
	//校验合作金融网点是否为空
	if(!doCheckBankIsNull(bussVariety)){
		alert("合作金融网点不存在");
		return false;
	}
	
	//校验境外银行是否为空
	if(!doCheckOutBankIsNull(bussVariety)){
		alert("境外银行不存在");
		return false;
	}

	//校验票据信息
	var page = $("input[id$='pageCode']").val();
	var bill = $("table[id^=gdt][id$=_bill]").find("tbody tr:visible");
	if(bill.length == 0){
		if(bussVariety == "CLMS10"){
			alert("请录入票据信息!");
			return false;
		}
		if(bussVariety == "CLMS11"){
			alert("请选择票据信息!");
			return false;
		}
		if(bussVariety == "CLMS15" || bussVariety == "CLMS17" || bussVariety == "CLMS19" || 
				bussVariety == "CLMS21" || bussVariety == "CLMS22"){
			alert("请选择信用证信息!");
			return false;
		}
		if(bussVariety == "CLMS24"){
			alert("请选择保函证信息!");
			return false;
		}
	}else{
		//承兑汇票
		if(bussVariety == "CLMS10"){
			var arr = $("input[id$='_bill.billAmount']");
			var amount = $("input[id$='_info.amount']").val();
			var flag = checkBillAndAmount(arr, amount);
			if(!flag){
				alert("票据总金额应与合同金额相等!");
				return false;   
			}
			if (!validateBill()){
				return false;
			}
		}
		
		//票据贴现
		if(bussVariety == "CLMS11"){
			//校验贴现利率是否统一
//			var arr = $("input[id$='_bill.billAmount']");
//			var amount = $("input[id$='_info.amount']").val();
//			if(!checkBillAndAmount(arr, amount)){
//				alert("票据总票面金额应与合同金额相等!");
//				return false;   
//			}
			//校验贴现利率是否一致
//			if(!checkBillDiscountRate()){
//				alert("票据贴现利率必须一致!");
//				return false; 
//			}
		}
		
		//信用证
		if(bussVariety == "CLMS17" || bussVariety == "CLMS19" || 
				bussVariety == "CLMS21" || bussVariety == "CLMS22"){
			if(!checkBillCurrencyNo()){
				alert("信用证币种应与合同币种一致!");
				return false;  
			}
			if(!checkBillAndAmountToLCG()){
				alert("信用证金额应与合同金额相等!");
				return false;   
			}
			var rate=$('input[id$=_info.rate]');
			if(rate && rate.val() !=''){
				if(100.0-parseFloat(rate.val().excludeNotNumericDot())<0){
					alert("利率值不能超过100");
					rate.val('');
					return false;
				}
			}
		}
	
		//保函, 校验 金额,币种
		if(bussVariety == "CLMS24"){
			if(!checkBillCurrencyNo()){
				alert("保函币种应与合同币种一致!");
				return false;  
			}
			if(!checkBillAndAmountToLCG()){
				alert("保函金额应与合同金额相等!");
				return false;   
			}
		}	
	}
	
	var files = $('input[id$=applyFiles_filetext]');
	if(!validateFileForamtBatch(files)){
		alert("系统不允许上传可执行格式的文件");
		return false;
	}
	//授信字段选择了“是”，必须选择授信合同
	if(!checkIsTakeCredit()){
		return false;
	}
	//担保字段选择了“是”，必须选择担保合同
	if(!checkIsTakeGuarantee()){
		return false;
	}
	//校验担保责任比例
	if(!checkeGuaranteeProportion()){
		return false;
	}
	//证券的发行金额总和与专项计划发行规模相等(资产证券化)
	if(!runAdd()){
		return false;
	}
	
	return true;
}

function doCheckOccupy(){
	var occupyList = $("input[id$='_amount.occupyProportion']");
	var count = 0;
	occupyList.each(function(){
		var val = this.value;
		if(val != null && val != "" && val != Number.NaN){
			count = accadd(count, parseFloat(val));
		} 
	});
	if(count != 100){
		return false;
	}else{
		return true;
	}
}

//校验票据贴现是否一致
//function checkBillDiscountRate(){
//	var flag = true;
//	var temp = new Array();
//	var int = 0;
//	$("input[id$='_bill.discountRate']").each(function(){
//		if(int == 0){
//			temp = this.value;
//			if(temp == ''){
//				return;
//			}
//		}else{
//			if(this.value == ''){
//				return;
//			}
//			if(temp != this.value){
//				flag = false;
//				return false;
//			}
//		}
//		int++;
//	})
//	return flag;
//}

//校验银团占用授信是否填写了占用金额
function doCheckCreditAmount(bussVariety){
	var flag = true;
	if(bussVariety == 'CLMS07'){
		$("input[id$='_amount.useAmount']:visible").each(function(){
			var tr = nstc.sf.findParent(this, 'tr');
			var useAmount = $(tr).find('input[id$=_amount.useAmount]').val();
			var creditNo = $(tr).find('input[id$=_amount.creditNo]').val();
			if(creditNo != '' && (useAmount == '' || useAmount == 0)){
				flag = false;
				return false;
			}
		});
	}
	return flag;
}

//校验授信占用 授信合同大行与融资合同大行是否一致
function doCheckBank(bussVariety){
	var flag = true;
	if(bussVariety == "CLMS07"){
		var pageCode = $("input[id='pageCode']").val();
		$("table[id="+pageCode+"_amount]").find("tbody tr:visible").each(function(){
			//var tr = nstc.sf.findParent(this, 'tr');
			var creditBankId = $(this).find('input[id$=_amount.creditBankId]').val();
			var assBankId = $(this).find('input[id$=_amount.assBankId]').val();
			if(assBankId!= undefined && assBankId != '' && assBankId != null
					&& creditBankId!= undefined && creditBankId != '' && creditBankId != null){
				var state = checkConAndCreditBank(assBankId,creditBankId);
				if(state == "false"){
					flag = false;
				}
			}
		})							 
	}else{							
		var creditBankId = $('input[id$=_credit.assBankId]').val();
		if(creditBankId == ''){
			try {
				 creditBankId =  $('input[id$=_credit.assBankId]')[1].value;
			} catch (e) {}
		}
		var assBankId = $('input[id$=_info.assBankId]').val();
		if(assBankId!= undefined && assBankId != '' && assBankId != null
				&& creditBankId!= undefined && creditBankId != '' && creditBankId != null){
			var state = checkConAndCreditBank(assBankId,creditBankId);
			if(state == "false"){
				flag = false;
			}
		}
	}
	return flag;
}

//校验票据币种
function checkBillCurrencyNo(){
	var contractCur = $("select[id$='_info.currencyNo']").val();
	var billCur = $("input[id$='_bill.currencyNo']").val();
	if(billCur==''){
		billCur = $("input[id$='_bill.currencyNo']")[1].value;
	}
	var flag = true;
	if(contractCur != undefined && contractCur != null && contractCur != ''
		&& billCur != undefined && billCur != null && billCur != ''){
		if(contractCur != billCur){
			flag = false;
		}
	}
	return flag;
}

//校验票据金额
function checkBillAndAmount(arr,amount){
	var sum = 0.0;
	var matching = new RegExp("," , "g") ;
	for ( var i = 0; i < arr.length; i++) {
		var billAmount = arr[i].value;
		if(billAmount != undefined && billAmount != null && billAmount != ''){
			sum = parseFloat(sum + parseFloat(billAmount.replace(matching , '')) * 100);//为防止计算中丢失精度，先转化为整数做运算，最后结果再转化为小数
		}
	}
	
	var sumVal = sum/100;
	var amountVal = parseFloat(amount.replace(matching , ''));
	if(parseFloat(sumVal) == parseFloat(amountVal).toFixed(2)){
		return true;   
	}
	return false;
}

function checkBillAndAmountToLCG(){
	
	var billAmount = $("input[id$='_bill.billAmount']").val();
	if(billAmount==''){
		billAmount = $("input[id$='_bill.billAmount']")[1].value;
	}
	var amount = $("input[id$='_info.amount']").val();
	
	var matching = new RegExp("," , "g") ;
	var billAmount= parseFloat(billAmount.toString().replace(matching , ''));
	var amount= parseFloat(amount.replace(matching , ''));
	if(billAmount == amount){
		return true;   
	}
	return false;
}

//校验数量值
function checkNum(obj){
	if(obj.value.charAt(0)== "-"){
		alert("数量输入不合法!不可以为负数.");
		obj.value = "";
		return ;
	}
	
	var str = obj.value;
	var patt1=/[0-9]/g;
	var temp = str.replace(patt1, "")
	if(temp != ""){
		alert("数量输入不合法!含有非数字字符"+temp);
		obj.value = "";
	}
	
}

//校验基本利率info
function checkInfoBaseRate(obj){
	var rate=$(obj);
	if(rate.val() !=''){
		if(100.0-parseFloat(rate.val().excludeNotNumericDot())<0){
			alert("利率值不能超过100");
			rate.val('');
			return;
		}
	}
	
	var floatType = $("select[id$='_info.floatType']").val();
	var rate = $("input[id$='_info.rate']").val();
	var floatValue = $("input[id$='_info.floatValue']").val();
	var baseRate = $("input[id$='_info.baseRate']").val();
    var rate = $("input[id$='_info.rate']").val();
	if(rate==""||rate==undefined){
		rate = countRate(baseRate,floatType,floatValue);
	}
	if(parseFloat(rate) < parseFloat(0.0)){
		rate = '';
		alert("利率值不合法!利率小于0");
		$(obj).val('');
	}
	if(parseFloat(rate) > parseFloat(100.0)){
		rate = '';
		alert("利率值不合法!利率大于100");
		$(obj).val('');
	}
	$("input[id$='_info.rate']").val(rate);
}

//校验利率
function checkRate(obj){
	var rate = parseFloat(obj.value.excludeNotNumericDot());
	var alt = obj.alt;
	if(rate){
		if($(obj).parent().next().find("[id$='.taxMemo']").val().length == 0){
			alert(alt + "不为空时, 请填写税率说明！");
			return false;
		}
		if(rate < 0){
			alert(alt + "不能为负数");
			obj.value = "";	
			return false;
		}
		if(rate > 100.0){
			alert(alt + "不能超过100");
			obj.value = "";
			return false;
		}
	}
	return true;
}
//校验是否为负数
function checkNegative(obj){
	var num1 = $(obj);
	if(num1.val() <0){
		var alt = obj.alt;
		alert(alt + "不能为负数");
		num1.val('');
		return;
	}
}

/**
 * 增加GridUnit行
 *
 * @param obj
 */
function smartForm_add(obj) {
	try {
		var names = obj.name.split('.');
		var unitname = names[0];
		return nstc.sf.addRow(unitname, "tableCopy_" + unitname);
	} catch (e) {}
	try{
		var frameId = window.frameElement && window.frameElement.id || '';
		if(window.parent != window)
			window.parent.smartForm_iFrameHeight(frameId);
	}catch(e){}
}

//回显数据
function setAccBill(arrObj){
	for ( var i = 0; i < arrObj.length; i++) {
		var data = arrObj[i];
		var btnAdd = $("input[id$='_bill.add']")[0];
		var tr_row = smartForm_add(btnAdd);
		var tr = $(tr_row);
		
		tr.find("input[id$='.billId']").val(data.billId);
		//tr.find("input[id$='.billAmount']").val(data.billAmount);
		
		var billNo = data.billNo;
		var billType = data.billType;
		var startDate = data.startDate;
		var endDate = data.endDate;
		var billAmount = data.billAmount;
		var accBankName = data.accBankName;
		var payee = data.payee;
		var recAccount = data.recAccount;
		
		var pageCode = $("input[id$='pageCode']").val();
		var amountHtml  = "<input id='"+pageCode+"_bill.billAmount' name='"+
		pageCode+"_bill.billAmount' type='hidden' value='"+billAmount+"'/>";
		tr.find("input[id$=_bill.billAmount]").parent().html("<span style ='text-align: right; font-weight: bold;'>"+FormatMoney(billAmount,2)+"</span>"
				+amountHtml);
		
		var billNoHtml  = "<input id='"+pageCode+"_bill.billNo' name='"+
		pageCode+"_bill.billNo' type='hidden' value='"+billNo+"'/>";
		tr.find("input[id$=_bill.billNo]").parent().html(billNo+billNoHtml);
		
		var billTypeHtml  = "<input id='"+pageCode+"_bill.billType' name='"+
		pageCode+"_bill.billType' type='hidden' value='"+billType+"'/>";
		tr.find("input[id$=_bill.billType]").parent().html(billType+billTypeHtml);
		
		var startDateHtml  = "<input id='"+pageCode+"_bill.startDate' name='"+
		pageCode+"_bill.startDate' type='hidden' value='"+startDate+"'/>";
		tr.find("input[id$=_bill.startDate]").parent().html(startDate+startDateHtml);
		
		var endDateHtml  = "<input id='"+pageCode+"_bill.endDate' name='"+
		pageCode+"_bill.endDate' type='hidden' value='"+endDate+"'/>";
		tr.find("input[id$=_bill.endDate]").parent().html(endDate+endDateHtml);
		
		var accBankNameHtml  = "<input id='"+pageCode+"_bill.accBankName' name='"+
		pageCode+"_bill.accBankName' type='hidden' value='"+accBankName+"'/>";
		tr.find("input[id$=_bill.accBankName]").parent().html(accBankName+accBankNameHtml);
		
		var payeeHtml  = "<input id='"+pageCode+"_bill.payee' name='"+
		pageCode+"_bill.payee' type='hidden' value='"+payee+"'/>";
		tr.find("input[id$=_bill.payee]").parent().html(payee+payeeHtml);
		
		var recAccountHtml  = "<input id='"+pageCode+"_bill.recAccount' name='"+
		pageCode+"_bill.recAccount' type='hidden' value='"+recAccount+"'/>";
		tr.find("input[id$=_bill.recAccount]").parent().html(recAccount + recAccountHtml);
		
	}
}
//回显数据
function setLCBill(data){
	
	var checks= $('input[id$="_bill.billId"]');
	if(checks != undefined && checks.length != 0){
		$(checks).each(function(){
			if(this.value==undefined || this.value == null || this.value == '')return;
			nstc.sf.delCurrRow(this)
		});
	}
	
	var btnAdd = $("input[id$='_bill.add']")[0];
	var tr_row = smartForm_add(btnAdd);
	var tr = $(tr_row);
	
	tr.find("input[id$='.billId']").val(data.billId);
	tr.find("input[id$='.billAmount']").val(data.billAmount);
	tr.find("input[id$='.currencyNo']").val(data.currencyNo);
	
	var billNo = data.billNo;
	var billType = data.billType;
	var nature = data.nature;
	var currencyName = data.currencyName;
	var endDate = data.endDate;
	var startDate = data.startDate;
	var billAmount = data.billAmount;
	var accBankName = data.accBankName;
	
	var pageCode = $("input[id$='pageCode']").val();
	var amountHtml  = "<input id='"+pageCode+"_bill.billAmount' name='"+
	pageCode+"_bill.billAmount' type='hidden' value='"+billAmount+"'/>";
	tr.find("input[id$=_bill.billAmount]").parent().html("<span style ='text-align: right; font-weight: bold;'>"+FormatMoney(billAmount,2)+"</span>"
			+amountHtml);
	
	var billNoHtml  = "<input id='"+pageCode+"_bill.billNo' name='"+
	pageCode+"_bill.billNo' type='hidden' value='"+billNo+"'/>";
	tr.find("input[id$=_bill.billNo]").parent().html(billNo + billNoHtml);
	
	var billTypeHtml  = "<input id='"+pageCode+"_bill.billType' name='"+
	pageCode+"_bill.billType' type='hidden' value='"+billType+"'/>";
	tr.find("input[id$=_bill.billType]").parent().html(billType + billTypeHtml);
	
	var startDateHtml  = "<input id='"+pageCode+"_bill.startDate' name='"+
	pageCode+"_bill.startDate' type='hidden' value='"+startDate+"'/>";
	tr.find("input[id$=_bill.startDate]").parent().html(startDate + startDateHtml);
	
	var natureHtml  = "<input id='"+pageCode+"_bill.nature' name='"+
	pageCode+"_bill.nature' type='hidden' value='"+nature+"'/>";
	tr.find("input[id$=_bill.nature]").parent().html(nature + natureHtml);
	
	var accBankNameHtml  = "<input id='"+pageCode+"_bill.accBankName' name='"+
	pageCode+"_bill.accBankName' type='hidden' value='"+accBankName+"'/>";
	tr.find("input[id$=_bill.accBankName]").parent().html(accBankName + accBankNameHtml);
	
	var currencyNameHtml  = "<input id='"+pageCode+"_bill.currencyName' name='"+
	pageCode+"_bill.currencyName' type='hidden' value='"+currencyName+"'/>";
	tr.find("input[id$=_bill.currencyName]").parent().html(currencyName + currencyNameHtml);
	
	var endDateHtml  = "<input id='"+pageCode+"_bill.endDate' name='"+
	pageCode+"_bill.endDate' type='hidden' value='"+endDate+"'/>";
	tr.find("input[id$=_bill.endDate]").parent().html(endDate + endDateHtml);
	
}
//回显数据   保函
function setLGBill(data){
	
	var checks= $('input[id$="_bill.billId"]');
	if(checks != undefined && checks.length != 0){
		$(checks).each(function(){
			if(this.value==undefined || this.value == null || this.value == '')return;
			nstc.sf.delCurrRow(this)
		});
	}
	
	var btnAdd = $("input[id$='_bill.add']")[0];
	var tr_row = smartForm_add(btnAdd);
	var tr = $(tr_row);
	
	
	tr.find("input[id$='.billId']").val(data.billId);
	tr.find("input[id$='.billAmount']").val(data.billAmount);
	tr.find("input[id$='.currencyNo']").val(data.currencyNo);
	
	var billNo = data.billNo;
	var billType = data.billType;
	var payee = data.payee;
	var currencyName = data.currencyName;
	var startDate = data.startDate;
	var billAmount = data.billAmount;
	var accBankName = data.accBankName;
	var endDate = data.endDate;
	  
	var pageCode = $("input[id$='pageCode']").val();
	var amountHtml  = "<input id='"+pageCode+"_bill.billAmount' name='"+
	pageCode+"_bill.billAmount' type='hidden' value='"+billAmount+"'/>";
	tr.find("input[id$=_bill.billAmount]").parent().html("<span style ='text-align: right; font-weight: bold;'>"+FormatMoney(billAmount,2)+"</span>"
			+amountHtml);
	
	var billNoHtml  = "<input id='"+pageCode+"_bill.billNo' name='"+
	pageCode+"_bill.billNo' type='hidden' value='"+billNo+"'/>";
	tr.find("input[id$=_bill.billNo]").parent().html(billNo + billNoHtml);
	

	var startDateHtml  = "<input id='"+pageCode+"_bill.startDate' name='"+
	pageCode+"_bill.startDate' type='hidden' value='"+startDate+"'/>";
	tr.find("input[id$=_bill.startDate]").parent().html(startDate + startDateHtml);
	
	var endDateHtml  = "<input id='"+pageCode+"_bill.endDate' name='"+
	pageCode+"_bill.endDate' type='hidden' value='"+endDate+"'/>";
	tr.find("input[id$=_bill.endDate]").parent().html(endDate+endDateHtml);
	
	var accBankNameHtml  = "<input id='"+pageCode+"_bill.accBankName' name='"+
	pageCode+"_bill.accBankName' type='hidden' value='"+accBankName+"'/>";
	tr.find("input[id$=_bill.accBankName]").parent().html(accBankName + accBankNameHtml);
	
	var payeeHtml  = "<input id='"+pageCode+"_bill.payee' name='"+
	pageCode+"_bill.payee' type='hidden' value='"+payee+"'/>";
	tr.find("input[id$=_bill.payee]").parent().html(payee + payeeHtml);

	var currencyNameHtml  = "<input id='"+pageCode+"_bill.currencyName' name='"+
	pageCode+"_bill.currencyName' type='hidden' value='"+currencyName+"'/>";
	tr.find("input[id$=_bill.currencyName]").parent().html(currencyName + currencyNameHtml);
	
	var billTypeHtml  = "<input id='"+pageCode+"_bill.billType' name='"+
	pageCode+"_bill.billType' type='hidden' value='"+billType+"'/>";
	tr.find("input[id$=_bill.billType]").parent().html(billType + billTypeHtml);
}
//展示单据
function showSDBillMsg(obj){
	var tr = $(nstc.sf.findParent(obj,"TR"));
	var wbId = tr.find("input[id$=.billId]").val();
	var url = "BMMS@showSDDetail.sf?m=v&wbId=" + wbId;
	openwin(url, '单据详情', 800, 500);
}
function checkAccbillCustomized(){
	 var isCustomized =  $("[id$='isCustomized']").val();
	 if (isCustomized==1){
		 var otherFees = $("[id$='otherFees']").val();
		 var chargeOffPath = $("[id$='chargeOffPath']").val();
		 var billLevelList =$("[id$='billLevel']");
		 if(otherFees==''||otherFees==null){
			 alert("其他费用必填！")
			 return false;
		 }else if(chargeOffPath==''||chargeOffPath==null){
			 alert("出账路径必填！")
			 return false;
		 }
		 var tab = document.getElementById("gdt_conAccbill_bill");
			var trs = $(tab).find('tbody tr:visible');
			for ( var int = 0; int < trs.length; int++) {
				var billLevel = $(trs[int]).find("input[id$='billLevel']").val();
			
				
				 if (billLevel == undefined || billLevel == "") {
						alert("票据承兑等级必填！");
						return false;
						
				 }
			}
			return true;
		 /*for ( var i = 0; i < billLevelList.length; i++) {
				if (billLevelList[i].val()==''||billLevelList[i].val()==null) {
					alert("票据承兑等级必填！")
					 return false;
				}
		 }*/
		 
	 }else{
		 return true;
	 }
}
function validateOtherFees(obj) {
	var otherFeesStr = obj.value;
	var otherFees = parseFloat(otherFeesStr.replace("," , ''))
	if(!validatePositiveNumber(otherFees)) {
		alert("请输入正数！");
		obj.value = "";
		obj.focus();
	}
}
//进入修正待处理页面
function showAmeWait4IntSource(){
	location.href = "GDEBIT@gdt_intSource.sf?m=e";
}
//返回操作
function doReturn(){
	location.href = "GDEBIT@gdt_contract.sf?m=v";
}

/**
 * 根据table设置为只读
 * lihongling
 * @param table
 */
function doReadOnly(table){
	var selectArray = table.find("select:visible");
	var inputArray=table.find("input[type='text']:visible");
	setDisabled(selectArray);
	setDisabled(inputArray);
}
/**
 * 设置为只读
 * lihongling
 * @param arr
 */
function setDisabled(arr){
	 for(i = 0;i < arr.length;i++ ){
		 var input = $(arr[i]);
		 var c=input.val();
		 if(isNotNull(input.val())){
			 input.attr("disabled","true");
         }
	 }
}