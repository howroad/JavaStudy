//间接融资-贸易融资》进口L/C开证
$(function(obj){
	/*var bussClass = $("select[id$=.bussClass]").val('CLMS03');*/
	var bussClass = $("select[id$='.bussClass']").attr('value','CLMS03');
	doChange(bussClass[0]);
	//隐藏业务品种和分类,展示值
	/*$("select[id$=.bussVariety]").val('CLMS15');*/
	$("select[id$='.bussVariety']").attr('value','CLMS15');
	var bussVariety = $("select[id$='.bussVariety']");
	var cltName = $("input[id$='.cltName']").val();
	var apply = $("input[id$='_form.applyId']").val();
	if(apply != undefined && apply != null && apply != ''){
		doHidden(bussClass,bussVariety);	
		$("input[id$='_bill.wheBackToBack']").attr("disabled","true");
		//母证不可改
		doHiddenApply($('input[id$=_info.superLcNo]'));
		changeReadOnly();
		//合同来源，当合同是从信用证系统传入时，票面信息都不允许修改
		var contractChannel = $("input[id$='_info.contractChannel']").val();
		if(contractChannel =="2"){
			changeBillReadOnly();
			$("input[id$='_bill.partialShipments']").attr("disabled","true");
			$("input[id$='_bill.recourse']").attr("disabled","true");
			$("input[id$='_bill.tranShipment']").attr("disabled","true");
		}
	}
	var m = document.getElementById('m').value;
	if(m=='e' || m == 'v' || m == ''){
		doHidden(bussClass,bussVariety);	
	}
	changeBackToBack();
	changeForexType();
	if(m =='v'){
		$("input[id$='_bill.wheBackToBack']").attr("disabled","true");
		$("input[id$='_bill.partialShipments']").attr("disabled","true");
		$("input[id$='_bill.recourse']").attr("disabled","true");
		$("input[id$='_bill.tranShipment']").attr("disabled","true");
		var superLcNo = $('input[id$=_info.superLcNo]');
		doHiddenApply(superLcNo);
		$("font").text("");
		var productDesc = $('input[id$=_bill.productDesc]');
		productDesc.parent().parent().removeAttr('noWrap');
	}
	
	var channel = $("input[id$='gdt_conImportLC_form.channel']").val();
    //当channel字段不为GDEBIT时，将带入的数据置换为不可写
	if(isNotNull(channel) && channel != "GDEBIT"){
		var table = $("#gdt_conImportLC_info");
		doReadOnly(table);
	}
});
//合同是信用证系统生成时，不允许修改证的信息
function changeBillReadOnly(){
	//信用证号
	var blNo = $("input[id$=_bill.blNo]");
	var blNoHtml = "<input id='gdt_conImportLC_bill.blNo' name='gdt_conImportLC_bill.blNo' type='hidden' value='"+blNo.val()+"'/>";
	blNo.parent("span").html(blNo.val()+blNoHtml);
	//通知行
	var advisingBankName = $("input[id$=_bill.advisingBankName]");
	var advisingBankNameHtml = "<input id='gdt_conImportLC_bill.advisingBankName' " +
			"name='gdt_conImportLC_bill.advisingBankName' type='hidden' value='"+advisingBankName.val()+"'/>";
	advisingBankName.parent("span").html(advisingBankName.val()+advisingBankNameHtml);
	//开证金额
	var blAmount = $("input[id$=_bill.blAmount]");
	var blAmountHtml = "<input id='gdt_conImportLC_bill.blAmount' " +
	"name='gdt_conImportLC_bill.blAmount' type='hidden' value='"+blAmount.val()+"'/>";
	blAmount.parent("span").html(blAmount.val()+blAmountHtml);
	//开证日期
	var issueDate = $("input[id$=_bill.issueDate]");
	var issueDateHtml = "<input id='gdt_conImportLC_bill.issueDate' name='gdt_conImportLC_bill.issueDate' type='hidden' value='"+issueDate.val()+"'/>";
	issueDate.parent("span").html(issueDate.val()+issueDateHtml);
	//有效期
	var dueDate = $("input[id$=_bill.dueDate]");
	var dueDateHtml = "<input id='gdt_conImportLC_bill.dueDate' name='gdt_conImportLC_bill.dueDate' type='hidden' value='"+dueDate.val()+"'/>";
	dueDate.parent("span").html(dueDate.val()+dueDateHtml);
	//信用证性质   ----
	var creditNature = $("select[id$=_bill.creditNature]");
	creditNature.parent().html("<span>"+creditNature.find('option:selected').text()+"</span>"+
			"<input id='gdt_conImportLC_bill.creditNature' name='gdt_conImportLC_bill.creditNature'" +
			" type='hidden' value='"+creditNature.val()+"' />"); 
	//交单期类型   ---
	var forexType = $("select[id$=_bill.forexType]");
	forexType.parent().html("<span>"+forexType.find('option:selected').text()+"</span>"+
			"<input id='gdt_conImportLC_bill.forexType' name='gdt_conImportLC_bill.forexType'" +
			" type='hidden' value='"+forexType.val()+"' />"); 
	//远期天数
	var payTerm = $("input[id$=_bill.payTerm]");
	var payTermHtml = "<input id='gdt_conImportLC_bill.payTerm' name='gdt_conImportLC_bill.payTerm' type='hidden' value='"+payTerm.val()+"'/>";
	payTerm.parent("span").html(payTerm.val()+payTermHtml);
	//起运港
	var startPlace = $("input[id$=_bill.startPlace]");
	var startPlaceHtml = "<input id='gdt_conImportLC_bill.startPlace' name='gdt_conImportLC_bill.startPlace' type='hidden' value='"+startPlace.val()+"'/>";
	startPlace.parent("span").html(startPlace.val()+startPlaceHtml);
	//目的港
	var endPlace = $("input[id$=_bill.endPlace]");
	var endPlaceHtml = "<input id='gdt_conImportLC_bill.endPlace' name='gdt_conImportLC_bill.endPlace' type='hidden' value='"+endPlace.val()+"'/>";
	endPlace.parent("span").html(endPlace.val()+endPlaceHtml);
	//最迟装运日
	var lastShipmentDate = $("input[id$=_bill.lastShipmentDate]");
	var lastShipmentDateHtml = "<input id='gdt_conImportLC_bill.lastShipmentDate' name='gdt_conImportLC_bill.lastShipmentDate' type='hidden' value='"+lastShipmentDate.val()+"'/>";
	lastShipmentDate.parent("span").html(lastShipmentDate.val()+lastShipmentDateHtml);
	//货物描述
	var productDesc = $("textarea[id$=_bill.productDesc]");
	var productDescHtml = "<input id='gdt_conImportLC_bill.productDesc' name='gdt_conImportLC_bill.productDesc' type='hidden' value='"+productDesc.val()+"'/>";
	productDesc.parent("span").html(productDesc.val()+productDescHtml);
}
//信用证有申请时，申请中录入的信息不能改
function changeReadOnly(){
	//单位
	var clt = $("input[id$=_info.cltName]");
	doHiddenApply(clt);
	//合作金融网点
	var assBankName = $('input[id$=_info.assBankName]');
	doHiddenApply(assBankName);
	//贸易合同编号
	var bill_contractNo = $('input[id$=_bill.contractNo]');
	doHiddenApply(bill_contractNo);
	//设置开证银行
	var bankNo = $('input[id$=_info.bankNo]').val();
	if(bankNo!=''){
		$("[name$='_bill.bankNo']").val(bankNo);
	}
	//信用证类型，币种
	var creditType = $("select[id$=_bill.creditType]");
	var currency = $("select[id$=_bill.currency]");
	doHiddenCuy(creditType,currency);
	//供应商
	var beneName = $("input[id$=_bill.beneName]");
	var beneNameHtml = "<input id='gdt_conImportLC_bill.beneName' name='gdt_conImportLC_bill.beneName' type='hidden' value='"+beneName.val()+"'/>";
	beneName.parent("span").html(beneName.val()+beneNameHtml);
	//母证
	var superLcNo = $("input[id$=_bill.superLcNo]");
	var superLcNoHtml = "<input id='gdt_conImportLC_bill.superLcNo' name='gdt_conImportLC_bill.superLcNo' type='hidden' value='"+superLcNo.val()+"'/>";
	superLcNo.parent("span").html(superLcNo.val()+superLcNoHtml);
}
//币种和授信类型不能改
function doHiddenCuy(creditType,currency){
	var pageCode = $("input[id$='pageCode']").val();
	creditType.hide();
	currency.hide();
	creditType.parent().html("<span>"+creditType.find('option:selected').text()+"</span>" +
			"<input id='"+pageCode+"_bill.creditType' name='"+pageCode+
			"_bill.creditType' type='hidden' value='"+creditType.val()+"' />"); 
	currency.parent().html("<span>"+currency.find('option:selected').text()+"</span>"+
			"<input id='"+pageCode+"_bill.currency' name='"+pageCode+
			"_bill.currency' type='hidden' value='"+currency.val()+"' />"); 
}
//选择单位
function selectNsClient(){
	var url = "GDEBIT@gdt_nsClientSlt.sf?isClear=1";
	openwin(url, '单位列表', 500, 400);
}
//选择 -- 修改值
function setNsclient(obj){
	var cltNo = $("input[id$=_info.cltNo]").val();
	if(cltNo != obj.cltNo){
		try {
			emptyGuarantee()
		} catch (e) {}
		
		try {
			emptyCredit()
		} catch (e) {}
	}
	$("input[id$=.cltNo]").val(obj.cltNo);
	$("input[id$=.cltName]").val(obj.cltName);
}
//切换即期远期
function changeForexType(){
	var forexType = $("[name$='.forexType']").val();
	if(forexType=='SPOT'){//即期
		$("[name$='.payTerm']").hide();
		$("[name$='.payTerm']").val("");
		$("[name$='.payTerm']").removeAttr("validate");
		$("[doc=payTermTag]").find("label").html("");
	}else if(forexType='FORWARD'){//远期
		$("[name$='.payTerm']").show();
		$("[name$='.payTerm']").attr("validate","require|");
		$("[doc=payTermTag]").find("label").html("<FONT color=red>*</FONT>远期天数");
	}
}
//是否背对背
function changeBackToBack(){
	var back=$('input:radio[name$="wheBackToBack"]:checked').val();
	if(back == 0){
		$(nstc.sf.findParent($("[name$='.superLcNo']").get(0), "TR")).hide();
		$(nstc.sf.findParent($("[name$='.superOpenBank']").get(0), "TR")).hide();
		$("[name$='.superLcNo']").val("");
		$("[name$='.superCurrency']").val("");
		$("[name$='.superLcNo']").removeAttr("validate");
		var superCurrencyName = "<input id='gdt_conImportLC_bill.superCurrencyName' name='gdt_conImportLC_bill.superCurrencyName' type='hidden'/>";
		$("[name$='.superCurrencyName']").parent("span").html(superCurrencyName);
		var superOpenBank = "<input id='gdt_conImportLC_bill.superOpenBank' name='gdt_conImportLC_bill.superOpenBank' type='hidden'/>";
		$("[name$='.superOpenBank']").parent("span").html(superOpenBank);
		var superBlAmount = "<input name='gdt_conImportLC_bill.superBlAmount' id='gdt_conImportLC_bill.superBlAmount' type='hidden' format='money'/>";
		$("[name$='.superBlAmount']").parent("span").html(superBlAmount);
	}else if(back == 1){
		$(nstc.sf.findParent($("[name$='.superLcNo']").get(0), "TR")).show();
		$(nstc.sf.findParent($("[name$='.superOpenBank']").get(0), "TR")).show();
		$("[name$='.superLcNo']").attr("validate","require|");
	}
}
	//选择信用证
function selectCreditBill(){
	var applyNo = $("input[id$=_info.cltNo]").val();
	if(applyNo == undefined || applyNo == null || applyNo == ''){
		alert("请先选择单位")
		return ;
	}
	var bussVariety = $("select[id$=_form.bussVariety]").val();
	if(bussVariety == undefined)bussVariety = $("input[id$=_form.bussVariety]").val();
	var url="GDEBIT@gdt_select_LC.sf?m=v&applyNo="+applyNo+"&bussVariety="+bussVariety;
	openwin(url, '选择国际信用证', 800,600);
}
	
// 设置信用证母证
function setLCBill(result){
	$("[name$='.superLcNo']").val(result.billNo);
	$("[name$='.superCurrency']").val(result.currencyNo);
	var superCurrencyName = "<input id='gdt_conImportLC_bill.superCurrencyName' name='gdt_conImportLC_bill.superCurrencyName' type='hidden' value='"+result.currencyName+"'/>";
	$("[name$='.superCurrencyName']").parent("span").html(result.currencyName+superCurrencyName);
	var superOpenBank = "<input id='gdt_conImportLC_bill.superOpenBank' name='gdt_conImportLC_bill.superOpenBank' type='hidden' value='"+result.accBankName+"'/>";
	$("[name$='.superOpenBank']").parent("span").html(result.accBankName+superOpenBank);
	var superBlAmount = "<input name='gdt_conImportLC_bill.superBlAmount' id='gdt_conImportLC_bill.superBlAmount' type='hidden' format='money' value='"+result.billAmount+"'/>";
	$("[name$='.superBlAmount']").parent("span").html(FormatMoney0(result.billAmount)+superBlAmount);
	
}
//计算期限
function checkStartDate(){
	var startDate = $('input[id$=.issueDate]').val();
	var endDate = $('input[id$=.dueDate]').val();
	if(!compareDate(startDate, endDate, '开证日期不能晚于有效期')){
		$('input[id$=.dueDate]').val('');
		return false;
	}
	if(startDate != '' && endDate != ''){
		var termDay = DateCompare(startDate,endDate);
		$("input[id$=.termDay]").val(termDay);
	}
	checkLatestDate();
}

//校验最迟装运日
function checkLatestDate(){
	var endDate = $('input[id$=.dueDate]').val();
	var latestShippingDate = $('input[id$=.lastShipmentDate]').val();
	if(endDate =='' || latestShippingDate ==''){
		return;
	}
	if(!compareDate(latestShippingDate, endDate, '最迟装运日不能晚于有效期')){
		$('input[id$=.lastShipmentDate]').val('');
		return false;
	}
}



//计算开立手续费
function calFee(){
	var feesRateObj = $('input[id$=.feesRate]');
	var feesRate = feesRateObj.val();
	var cost = $('input[id$=.cost]');
	if(feesRate!=''){
		if(100.0-parseFloat(feesRate.excludeNotNumericDot())<0){
			alert("利率值不能超过100");
			feesRateObj.val('');
			cost.val("");
			return;
		}
	}
	var amount = $('input[id$=.blAmount]').val();
	if(feesRate!='' && amount !=''){
		amount=parseFloat(amount.excludeNotNumericDot());
		feesRate=parseFloat(feesRate.excludeNotNumericDot());
		cost.val(FormatMoney0(amount*feesRate/100));
	}else{
		cost.val("");
	}
}

//选择 -- 金融合作网点
var lastBankNo = "";
function setAssBank(obj){
	if(lastBankNo == "")lastBankNo = $("input[id$='_info.bankNo']").val();
	if(lastBankNo == "")lastBankNo = obj.bankNo;
	var assBankId= obj.assBankId;
	var assBankName= obj.assBankName;
	var bankNo = obj.bankNo;
	$("input[id$='_info.assBankId']").val(assBankId);
	$("input[id$='_info.assBankName']").val(assBankName);
	$("[name$='_bill.bankNo']").val(bankNo);
	var html = "<input id='gdt_conImportLC_bill.bankName' name='gdt_conImportLC_bill.bankName' type='hidden' value='"+obj.bankName+"'/>"
	$("[name$='_bill.bankName']").parent("span").html(obj.bankName+html);
	//切换合作金融网点大行，清空授信担保信息
	if(lastBankNo !=bankNo){
		try {
			emptyGuarantee();
		} catch (e) {}
		
		try {
			emptyCredit();
		} catch (e) {}
		lastBankNo = bankNo;
	}
}

function checkNumber(obj){
	if(obj.value!=''){
		obj.value =obj.value.replace(/\D/g,'');
		if(isNaN(obj.value)){
			alert("远期天数输入不合理，请重新输入");
			obj.value='';
			obj.focus();
			return false;
		}
	}
	smartPage_checkLength(obj,3);
}
