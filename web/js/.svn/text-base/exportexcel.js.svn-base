/*--------- 命名空间 ---------*/
if (!nstc) var nstc = {};

/**页面加载完成后js改变tr内容导出时会丢失，使用此方法单独处理*/
nstc.exportExcelColspan=function(tb, name){
	var t = $("#"+tb)[0];
	if(typeof(t) == "undefined" || t == null){
		alert("找不到待导出的表"+tb);
		return;
	}
	//取tbody里显示行的数量
	var row_l = $("#"+tb).find("tbody").find("tr:visible").length;
	if(row_l < 1){
		alert("没有可导出的数据");
		return;
	}
	var frm=document.getElementById("_ExcelForm_");
	var form = $(nstc.sf.findParent($("#"+tb).get(0),"FORM"));
	if(frm==null){
		frm=document.createElement("<form style='display:none;' id='_ExcelForm_' name='_ExcelForm_' method='post' action='LGM-Web-ROOT/pages/excel.jsp?name="+name+"' target='message' ></form>");
		frm.innerHTML="<input  name='_ExcelText_' type='hidden' id='_ExcelText_' />";
		document.body.appendChild(frm);
	}
	$("#tableCopy_"+tb).remove();
	 
	var str=getShowTableHTML(tb);
	
	str = str.replace(/&nbsp;/g," ");
	$("#_ExcelText_").val(str);
	frm.submit();
}

function getShowTableHTML(obj){
	if($("#"+obj+"_clone").length < 1){
		var table = $("#"+obj).clone();
		table.attr("id",obj+"_clone");
		table.hide();
		document.appendChild(table[0]);
		$("#"+obj+"_clone THEAD TR").insertBefore("#"+obj+"_clone TBODY TR:first");
		$("#"+obj+"_clone TBODY TR TD:last-child:hidden").remove();
	}
	var o = $("#"+obj).find("tbody tr:visible");
	var f = o.first().html();
	var l = o.last().html();
	$($("#"+obj+"_clone").find("tr")[2]).html(f);
	$("#"+obj+"_clone").find("tr").last().html(l);
	return $("#"+obj+"_clone")[0].outerHTML;
	
}

//导出table 
nstc.exportExcel=function(tb,name,tb2){
	var t = $("#"+tb)[0];
	if(typeof(t) == "undefined" || t == null){
		alert("找不到待导出的表"+tb);
		return;
	}
	//取tbody里显示行的数量
	var row_l = $("#"+tb).find("tbody").find("tr:visible").length;
	if(row_l < 1){
		alert("没有可导出的数据");
		return;
	}
	
	var frm=document.getElementById("_ExcelForm_");
	var form = $(nstc.sf.findParent($("#"+tb).get(0),"FORM"));
	if(frm==null){
		frm=document.createElement("<form style='display:none;' id='_ExcelForm_' name='_ExcelForm_' method='post' action='LGM-Web-ROOT/pages/excel.jsp?name="+name+"' target='message' ></form>");
		frm.innerHTML="<input  name='_ExcelText_' type='hidden' id='_ExcelText_' />";
		document.body.appendChild(frm);
	}
	$("#tableCopy_"+tb).remove();
	 
	var str=doDealExcelTable(tb);
	
	var str2;
	if(tb2 != null){
		str2 = doDealExcelTable2(tb2);
	}
	var temp='';
	if(str2 != null){
		temp = $(str2).find("TBODY").html();
	}
	var vv = str.split("</TBODY>")[0]+"<TR></TR><TR></TR>"+temp+"</TBODY>"+str.split("</TBODY>")[1];
	vv = vv.replace(/&nbsp;/g," ");
	$("#_ExcelText_").val(vv);
	frm.submit();
}
function doDealExcelTable(obj){
	if($("#"+obj+"_clone").length < 1){
		var table = $("#"+obj).clone();
		table.attr("id",obj+"_clone");
		table.hide();
		document.appendChild(table[0]);
		$("#"+obj+"_clone THEAD TR").insertBefore("#"+obj+"_clone TBODY TR:first");
		$("#"+obj+"_clone TBODY TR TD:last-child:hidden").remove();
	}
	return $("#"+obj+"_clone")[0].outerHTML;
}

function doDealExcelTable2(obj){
	if($("#"+obj+"_clone").length < 1){
		var table = $("#"+obj).clone();
		table.attr("id",obj+"_clone");
		table.hide();
		document.appendChild(table[0]);
		$("#"+obj+"_clone THEAD TR").insertBefore("#"+obj+"_clone TBODY TR:first");
		
	}
	return $("#"+obj+"_clone")[0].outerHTML;;
}
//根据选择的行导出table,rowLength：表头的行数 
nstc.exportExcelByChoice=function(tb,name,rowLength){
	var t = $("#"+tb);
	if(typeof(t[0]) == "undefined" || t[0] == null) alert("找不到待导出的表"+tb);
	
	//取tbody里显示行的数量
	var row_l = $("#"+tb).find("tbody").find("tr:visible").length;
	if(row_l < 1){
		alert("没有可导出的数据");
		return;
	}
	
	var isOK = false;
	$("#"+tb).find("tbody").find("tr").each(function(){
		//页面复选框选中或者状态为已选
		if($(this).find("input[type=checkbox]").attr("checked") || $(this)[0].cells[0].innerHTML.indexOf("已选") > -1){
			isOK = true;
			return false;
		}
	});
	var rows = t.get(0).rows;	
	if(rows.length <= 2){
		alert("没有可导出的信息");
		return;
	}
	
	var frm=document.getElementById("_ExcelForm_");
	var form = $(nstc.sf.findParent(t.get(0),"FORM"));
	if(frm==null){
		frm=document.createElement("<form style='display:none;' id='_ExcelForm_' name='_ExcelForm_' method='post' action='LGM-Web-ROOT/pages/excel.jsp?name="+name+"' target='_self' ></form>");
		frm.innerHTML="<input  name='_ExcelText_' type='hidden' id='_ExcelText_' />";
		document.body.appendChild(frm);
	}
	var ht = $("#tableCopy_"+tb).clone();
	$("#tableCopy_"+tb).remove();
	var str=doDealExcelTableChoice(tb,rowLength,isOK);
	
	if(!isOK){
		//金额求和
		var i = 0;
		var _m_=0;
		$("table tr td input[name$=amount]").each(function(){
			i = parseInt(i)+1;
			_m_=parseFloat($(this).val().excludeNotNumericDot())+parseFloat(_m_);
		});
		
		var l = ht.children().length;
		var html_ = "<TR><TD align='right'>导出合计：</TD>";
		html_+="<TD colSpan='2'>"+"合计条数："+i+"条"+"</TD>";
		html_+="<TD colSpan='"+(l-4)+"'>"+"合计金额："+FormatMoney(_m_)+"元"+"</TD></TR>";
		str = str.split("</TBODY>")[0]+html_+"</TBODY>"+str.split("</TBODY>")[1];
	}else{
		str = sumBillAndAmount(ht,str);
	}
	
	$("#_ExcelText_").val(str);
	frm.submit();
	/** 清除上一次导出的内容，防止未刷新直接再次点击导出导出内容不变的BUG */
	if($("#"+tb+"_clone")!=null){
		$("#"+tb+"_clone").remove();
	}
	t.append(ht);
}
/***
 * js追加合计行 jquery提供的append()方法不起作用。。。。
 * @param html
 * @param table
 */
function sumBillAndAmount(tr,tableHTML){
	var count = "0";
	var amount = "0.00";
	var v = $("table tr td input[name$='sumBill']");
	if(typeof(v.get(0)) == "undefined" || v.get(0) == null){
		count = $("input[name$=currentBills]").val();
	}else{
		count = v.val();
	}
	var b = $("table tr td input[name$='sumAmount']");
	if(typeof(b.get(0)) == "undefined" || b.get(0) == null){
		amount = $("input[name$=currentAmount]").val();
	}else{
		amount = b.val();
	}
	var l = tr.children().length;
	var str = "<TR><TD align='right'>导出合计：</TD>";
	str+="<TD colSpan='2'>"+"合计条数："+count+"条"+"</TD>";
	str+="<TD colSpan='"+(l-4)+"'>"+"合计金额："+amount+"元"+"</TD></TR>";
	var html = tableHTML.split("</TBODY>")[0]+str+"</TBODY>"+tableHTML.split("</TBODY>")[1];
	return html;
}

function doDealExcelTableChoice(obj,rowLength,isOK){
	var rows = null;
	var table = null;
	if($("#"+obj+"_clone").length < 1){
		table = $("#"+obj).clone();
		table.attr("id",obj+"_clone");
		table.hide();		
		$(table.get(0)).find("THEAD TR").insertBefore($(table.get(0)).find("TBODY TR:first"));
		$(table.get(0)).find("TBODY TR TD:last-child:hidden").remove();
		rows = table.get(0).rows;
		/** 清除表头的复选框列 */
		rows[0].deleteCell(0);
	}	
	if(rows.length > rowLength){
		for(var i = rowLength ; i < rows.length; i++){
			//if(rows[i].cells[0].children[0].children[0].checked){
			if(!isOK || ($(rows[i].cells[0]).find("input[type='checkbox']").attr("checked") || rows[i].cells[0].innerHTML.indexOf("已选") > -1)){		
				//如果当前行被选中，则从复制的table中保留，但是要删除复选框列
				rows[i].deleteCell(0);
			}else{
				//如果当前行未被选中，则直接从复制的table中删除，不导出
				$(rows[i]).remove();
				i--;
			}
		}
	}
	return table.get(0).outerHTML;
}

nstc.selectExport = function (obj){
	smartForm_all_checkbox(obj,'checkbox');
	var v = $("table tr td input[name$='sumBill']");
	if(typeof(v.get(0)) == "undefined" || v.get(0) == null) return;
	var b = $("table tr td input[name$='sumAmount']");
	if(typeof(b.get(0)) == "undefined" || b.get(0) == null) return;
	var fs = $("input[name$=amount]");
	var rows = nstc.sf.findParent(fs[0],"table").rows;;
	if(obj.checked){
		var amount = 0;		
		var length = fs.length - 1;
		if(length > 0) {
			for(var i = 0 ; i < length ; i++){
				amount = parseFloat(amount) + parseFloat(fs[i].value.excludeNotNumericDot());
			}			
			v.val(length);
			b.val(FormatMoney(amount));
		}else{
			v.val(0);
			b.val("0.00");
		}
	}else{
		v.val(0);
		b.val("0.00");
	}
	if(rows.length > 2){
		v.parent().html("合计条数："+v.val()+"条"+v.get(0).outerHTML);
		b.parent().html(",合计金额："+b.val()+"元"+b.get(0).outerHTML);
	}
}


nstc.sumSelect = function (obj){
	if(nstc.sf.findParent(obj,"TR").innerHTML.indexOf("合计条数：") < 0){
		//jquery 取对象如果没有拿到的也是一个对象，只不过不是null,也不是undefined typeof(xx) == "undefined" 是false 
		//为了解决此问题用typeof(xx.get(0))=="undefined" 是true
		var v = $("table tr td input[name$='sumBill']");
		if(typeof(v.get(0)) == "undefined" || v.get(0) == null) return;
		var b = $("table tr td input[name$='sumAmount']");
		if(typeof(b.get(0)) == "undefined" || b.get(0) == null) return;
		var val = v.val();
		if(obj.checked){
			v.val(parseInt(val)+1);
			var money = $(nstc.sf.findParent(obj,"tr")).find("input[name$='amount']").val();
			b.val(FormatMoney(parseFloat(b.val().excludeNotNumericDot()) + parseFloat(money.excludeNotNumericDot())));
		}else{
			v.val(parseInt(val)-1);
			var money = $(nstc.sf.findParent(obj,"tr")).find("input[name$='amount']").val();
			b.val(FormatMoney(parseFloat(b.val().excludeNotNumericDot()) - parseFloat(money.excludeNotNumericDot())));
		}
		
		var rows = nstc.sf.findParent(obj,"table").rows;
		if(rows.length > 2){
			v.parent().html("合计条数："+v.val()+"条"+v.get(0).outerHTML);
			b.parent().html(",合计金额："+b.val()+"元"+b.get(0).outerHTML);
		}
	}
	
}