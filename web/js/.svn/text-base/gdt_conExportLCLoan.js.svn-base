//间接融资-贸易融资》出口L/C打包贷款
$(function(obj){
	var m = document.getElementById('m').value;
	/*var bussClass = $("select[id$=.bussClass]").val('CLMS03');*/
	var bussClass = $("select[id$='.bussClass']").attr('value','CLMS03');
	var bussVariety = $("select[id$='.bussVariety']");
	if(m =='a'){
		doChange(bussClass[0]);
		//隐藏业务品种和分类,展示值
		$("select[id$=.bussVariety]").val('CLMS22');
	}
	var cltName = $("input[id$=.cltName]").val();
	var apply = $("input[id$='_form.applyId']").val();
	
	if(apply != undefined && apply != null && apply != ''){
		var clt = $("input[id$=_info.cltName]");
		doHiddenApply(clt);
		doHidden(bussClass,bussVariety);
		//隐藏票据选择
		$('[id$="bill.selLC"]').hide();
	}
	
	var channel = $("input[id$='gdt_conExportLCLoan_form.channel']").val();
    //当channel字段不为GDEBIT时，将带入的数据置换为不可写
	if(isNotNull(channel) && channel != "GDEBIT"){
		var table = $("#gdt_conExportLCLoan_info");
		doReadOnly(table);
	}
});

//选择信用证
function doSelICreditBill(){
    var cltNo = $("input[id$=_info.cltNo]").val();
    if(cltNo == undefined || cltNo == null || cltNo == ''){
        alert("请先选择单位")
        return ;
    }
    //客户
    var cltName = $("input[id$='_info.cltName']").val();
    //币种
    var currencyNo = $("select[id$='_info.currencyNo']").val();
    //申请日
	var applyDate = $("input[id$=_info.applyDate]").val();
	if(applyDate == undefined){
		applyDate = $("input[id$=_info.contractDate]").val();
	}
    //到期日
    var endDate = $("input[id$=_info.endDate]").val();
    var bussVariety = $("select[id$=.bussVariety]").val();
    if(bussVariety == undefined)bussVariety = $("input[id$=.bussVariety]").val();
    var url="GDEBIT@gdt_select_ILC.sf?m=v&cltNo="+cltNo+"&bussVariety="+bussVariety+"&currencyNo="+currencyNo+"&applyDate="+applyDate+"&endDate="+endDate+"&cltName="+cltName;
    openwin(url, '选择信用证', 1000,600);
}
// 设置信用证
function setLCBill(result){
    var data = result;
    
    var checks= $('input[id$="_bill.billId"]');
    if(checks != undefined && checks.length != 0){
        $(checks).each(function(){
            if(this.value==undefined || this.value == null || this.value == '')return;
            nstc.sf.delCurrRow(this)
        });
    }
    
    var btnAdd = $("input[id$='_bill.add']")[0];
    var tr_row = smartForm_add(btnAdd);
    var tr = $(tr_row);
    
    
    
    tr.find("input[id$='.billId']").val(data.billId);
    tr.find("input[id$='.billNo']").val(data.billNo);
    var billNoHtml  = tr.find("input[id$='.billNo']").parent()[0].outerHTML;
    var billIdHtml = tr.find("input[id$='.billId']").parent()[0].outerHTML;
    var billNoLink = "<a href='#' onclick='showLCbill(this)'>" + data.billNo + "</a>";
    tr.find("input[id$=_bill.billNo]").parent().parent().html(billNoLink + billIdHtml + billNoHtml);
    
    tr.find("input[id$='.billType']").val(data.billType);
    var creditTypeHtml  = tr.find("input[id$='.billType']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.billType]").parent().parent().html(data.billType + creditTypeHtml);
    
    tr.find("input[id$='.currencyNo']").val(data.currencyNo);
    var currencyNoHtml  = tr.find("input[id$='.currencyNo']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.currencyNo]").parent().parent().html(data.currencyName + currencyNoHtml);
    
    tr.find("input[id$='.billAmount']").val(data.billAmount);
    var billAmountHtml  = tr.find("input[id$='.billAmount']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.billAmount]").parent().parent().html("<span style ='text-align: right; font-weight: bold;'>"+FormatMoney(data.billAmount,2)+"</span>" + billAmountHtml);
    
    tr.find("input[id$='.startDate']").val(data.startDate);
    var createDateHtml  = tr.find("input[id$='.startDate']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.startDate]").parent().parent().html(data.startDate + createDateHtml);
    
    tr.find("input[id$='.accBankName']").val(data.accBankName);
    var bankNameHtml  = tr.find("input[id$='.accBankName']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.accBankName]").parent().parent().html(data.accBankName + bankNameHtml);
    
    tr.find("input[id$='.endDate']").val(data.endDate);
    var endDateHtml  = tr.find("input[id$='.endDate']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.endDate]").parent().parent().html(data.endDate + endDateHtml);
    
    tr.find("input[id$='.supplierName']").val(data.supplierName);
    var supplierNameHtml  = tr.find("input[id$='.supplierName']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.supplierName]").parent().parent().html(data.supplierName + supplierNameHtml);
    
    tr.find("input[id$='.forexType']").val(data.forexType);
    var forexTypeHtml  = tr.find("input[id$='.forexType']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.forexType]").parent().parent().html(data.forexType + forexTypeHtml);
    
	$("select[id$='_info.currencyNo']").val(data.currencyNo);
    
//    tr.find("input[id$='.nature']").val(data.nature);
//    var natureHtml  = tr.find("input[id$='.nature']").parent()[0].outerHTML;
//    tr.find("input[id$=_bill.nature]").parent().parent().html(data.nature + natureHtml);
}


//提交/保存  之前先进行校验
function saveCheck(){
	$("input").removeAttr("disabled");
	var bussVariety = $("select[id$=.bussVariety]").val();
	if(!doCheckBankIsNull(bussVariety)){
		alert("合作金融网点不存在！");
		return false;
	}
    var bill = $("table[id^=gdt][id$=_bill]").find("tbody tr:visible");
    if(bill.length == 0){
        alert("请选择信用证信息!");
        return false;
    }
    var tr = $(bill.get(0));
    var currencyNo = $('select[id$=_info.currencyNo]').val();
    if(currencyNo == undefined ){
        currencyNo = $('input[id$=_info.currencyNo]').val();
    }
    var billCurrencyNo = tr.find('input[id$=_bill.currencyNo]').val();
    if(currencyNo != billCurrencyNo){
        alert("合同币种与信用证币种不一致");
        return false;
    }
    //校验合同金额
    var conAmt = $('input[id$=_info.amount]').val().excludeNotNumericDot();
    var billAmt = tr.find('input[id$=_bill.billAmount]').val().excludeNotNumericDot();
    if(conAmt- billAmt >0){
    	alert("合同金额不可大于信用证开证金额");
    	return false;
    }
    
    //申请日期
    var applyDate = $("input[id$=_info.applyDate]").val();
	var applyMsg = "申请日期";
	if(applyDate == undefined){
		applyDate = $("input[id$=_info.contractDate]").val();
		applyMsg = "签约日期"
	}
    
	//信用证开证日
	var lcStartDate = tr.find('input[id$=_bill.startDate]').val();
	if(!compareDate(lcStartDate,applyDate, applyMsg+'不能早于信用证的开证日期')){
		return false;
	}
	//到期日
	var endDate = $('input[id$=.endDate]').val();
	//信用证有效期
	var dueDate = tr.find('input[id$=_bill.endDate]').val();
	if(!compareDate(dueDate,endDate, '到期日不能早于信用证有效期')){
		return false;
	}
	//开始日
	var startDate = $('input[id$=.startDate]').val();
	if(!compareDate(applyDate,startDate,applyMsg+'不能晚于开始日期')){
		return false;
	}
   
    //校验附件
    var files = $('input[id$=applyFiles_filetext]');
    if(!validateFileForamtBatch(files)){
        alert("系统不允许上传可执行格式的文件");
        return false;
    }
    return true;
}