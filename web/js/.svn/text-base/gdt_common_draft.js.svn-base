$(function(){
	var payRanges = $('[id$="_bill.payRange"]:visible');
	for (var i = 0; i < payRanges.length; i++){
		changePayRange(payRanges[i]);
	}
	var useAims = $('[id$="_info.useAims"]').val();
	if (useAims == "false") {
		var payNo = $('[id$="info.payNo"]');
		payNo.removeAttr("class","");
		payNo.removeAttr("onclick","");
		payNo.removeAttr("readOnly","");
	} else {
		//未启用集团账户，将选框改为输入框
		var payName = $('[id$="info.payName"]');
		var openBankName = $('[id$="info.openBankName"]');
		showAsText (openBankName);
		showAsText (payName);
	}
});

$(function (){

	//判断是否为瑞茂通客户化
	var isCustomized;
	$.ajax({
		type: 'POST',
		url: "GDEBIT@AjaxIsCustomized.sf",
		async : false,
		//data: {'termDay':termDay, 'termDayType':termDayType, 'startDate':startDate,'currencyNo':currencyNo},
		dataType:'josn',
		success: function(data) {
			isCustomized=data;
			 if(isCustomized=='1') {
				var otherFeesTitle = $("[id$='otherFeesTitle']");
				otherFeesTitle.html("<font color='red'>*</font>"+otherFeesTitle.html());
				var chargeOffPathTitle = $("[id$='chargeOffPathTitle']");
				chargeOffPathTitle.html("<font color='red'>*</font>"+chargeOffPathTitle.html());
				var billLevelTitle = $("[id$='billLevelTitle']");
				billLevelTitle.html("<font color='red'>*</font>"+billLevelTitle.html());
				$("[id$='isCustomized']").val(1);
		}
		}
	});
});

var tr;
function selectAccount(){
//    var cltNo = $("input[id$=.cltNo]").val();
//    if(cltNo==null||cltNo==''){
//        alert("请选择单位");
//        return ;
//    }
    var lsh = $("input[id$=.assBankId]").val();
    if(lsh==null||lsh==''){
        alert("请选择合作金融网点");
        return ;
    }
    var cltNo = $("input[id$=.cltNo]").val();
    if(cltNo==null||cltNo==''){
        alert("请选择单位");
        return ;
    }
    var url = "GDEBIT@gdt_selectAccount.sf?m=v&lsh="+lsh + "&cltNo=" +cltNo;
    openwin(url, '选择账户', 900, 500);
}
//回写账户
function setAccount(obj){
    $("input[id$=.payNo]").val(obj.accountNo);
    $("input[id$=.payName]").val(obj.accountName);
    var payNameHtml  = $("input[id$='.payName']")[0].outerHTML;
    $("input[id$=.payName]").closest("td").find("span")[0].innerHTML=obj.accountName + payNameHtml;
    $("input[id$=.openBankName]").val(obj.bankName);
    var openBankNameHtml  = $("input[id$='.openBankName']")[0].outerHTML;
    $("input[id$=.openBankName]").closest("td").find("span")[0].innerHTML=obj.bankName + openBankNameHtml;
    
}
function mouseOverFun(obj, className){
	obj.className= className;
	smartForm_bt_onmouseover(this);
}
function mouseOutFun(obj, className){
	obj.className= className;
    martForm_bt_onmouseout(this);
}
function addNewRow(obj){
	smartForm_add(obj);
	setBillNum();
	changeConStartDate();
}
function selectRecClt(obj){
	tr = $(obj).closest("tr");
	var isInnerBill = tr.find("[id$='_bill.payRange']").val();
	var cltNo = $("input[id$='_info.cltNo']").val();
	if(isInnerBill == 1){
		url = "GDEBIT@gdt_nsClientSlt.sf?notByTreeNo=notByTreeNo&isClear=1&withoutCltNo=" + cltNo;
        openwin(url, '单位列表', 500, 400);
	}
}
function changePayRange(obj){
	var payRange = obj.value;
	var tr = $(obj).parents('tr').first();
	if(payRange == 1){
		tr.find('input[id$="_bill.payee"]').attr("readOnly",true);
	}else{
		tr.find('input[id$="_bill.payee"]').attr("readOnly",false);
	}
}
//选择 -- 修改值
function setNsclient(obj){
	if(!tr){
        var cltNo = $("input[id$=_info.cltNo]").val();
        if(cltNo != obj.cltNo){
            try {
                emptyGuarantee();
            } catch (e) {}
            
            try {
                emptyCredit();
            } catch (e) {}
            try {
                emptyBill();
            } catch (e) {}
            try {
    			emptyAccount();
    		} catch (e) {}
        }
        $("input[id$=_info.cltNo]").val(obj.cltNo);
        $("input[id$=_info.cltName]").val(obj.cltName);
	}else{
		tr.find("input[id$=_bill.payee]").val(obj.cltName);
	}
	tr = false;
}
//合同金额等于票面金额之和
function countContractAmt(){
    var conAmt = 0;
    var billAmtArray = $("input[id$='_bill.billAmount']");
    for(var i = 0; i < billAmtArray.length; i++){
        conAmt += Number(billAmtArray[i].value.excludeNotNumericDot());
    }
    var amount =  Math.round(conAmt*100)/100;//计算后金额保留两位小数 add by ly
    var pageCode = $("input[id='pageCode']").val();
    var conAmtHtml  = "<input id='"+pageCode+"_info.amount' name='"+
        pageCode+"_info.amount' type='hidden' value='"+amount+"'/>";
    //$("input[id$=.amount]").parent().html(FormatMoney(conAmt,2) + "元" + conAmtHtml);
    $("input[id$='.amount']").val(amount).change();
    if ('gdt_conAccbill' == pageCode) {
    	calCost($('[id$="_info.amount"]').get(0));
    }
}
//票据的最早开始日， 等于合同的开始日
function changeConStartDate(obj){
	var billStartDate = getMinDate("_bill.startDate");
	var applyDate = $("input[id$='_info.applyDate']").val();
	if(applyDate && DateCompare(billStartDate, applyDate) > 0){
		alert("出票日期不得早于申请日期!");
		$(obj).val(applyDate);
		obj.focus();
		return;
	}
	//delete by caiwenxiao 20180724 start
	/*var conStartDate = $("input[id$='_info.startDate']").val();
	$("input[id$='_info.startDate']").val(billStartDate);
	var conStartDateHtml = $("input[id$='_info.startDate']")[0].outerHTML;
	$('input[id$=_info.startDate]').parent().html(billStartDate + conStartDateHtml);
	//计算期限
	conStartDate = $("input[id$='_info.startDate']").val();
	var conEndDate = $("input[id$='_info.endDate']").val();
	if(conEndDate){
		var termDay = DateCompare(conStartDate, conEndDate);
		$("input[id$='_info.termDay']").val(termDay);
		var html  = $("input[id$='_info.termDay']")[0].outerHTML;
        $('input[id$=.termDay]').parent().html((isNaN(termDay) ? 0 : termDay) + "天" + html);
	}*/
	//delete by caiwenxiao 20180724 edn
}
//票据的最大到期日，等于合同的到期日
function changeConEndDate(obj){
    var billEndDate = getMaxDate("_bill.endDate");
    var conEndDate = $("input[id$='_info.endDate']").val();
    if(conEndDate && DateCompare(billEndDate, conEndDate) < 0){
		alert("结束不得晚于申请结束日期!");
		$(obj).val(conEndDate);
		obj.focus();
		return;
	}
    //delete by caiwenxiao 20180724 start
 /*   $("input[id$='_info.endDate']").val(billEndDate);
    var conEndDateHtml = $("input[id$='_info.endDate']")[0].outerHTML;
    $('input[id$=_info.endDate]').parent().html(billEndDate + conEndDateHtml);
	//计算期限
    conEndDate = $("input[id$='_info.endDate']").val();
    var conStartDate = $("input[id$='_info.startDate']").val();
    if(conStartDate){
        var termDay = DateCompare(conStartDate, conEndDate);
        $("input[id$='_info.termDay']").val(termDay);
        var html  = $("input[id$='_info.termDay']")[0].outerHTML;
        $('input[id$=_info.termDay]').parent().html((isNaN(termDay) ? 0 : termDay) + "天" + html);
    }*/
    //delete by caiwenxiao 20180724 end
}
function setBillNum(){
	var billAmtArray = $("input[id$='_bill.billAmount']");
    $("input[id$='_info.billNum']").val(billAmtArray.length - 1);
    var billNumHtml  = $("input[id$='_info.billNum']")[0].outerHTML;
    $("input[id$='_info.billNum']").closest("td").find("span")[0].innerHTML=billAmtArray.length - 1 + billNumHtml;
}
function delRow(obj){
	var url = obj.id;
	var list = $('[id='+url.substring(0,url.indexOf("."))+']');
	var checks=list.find("input[id$='_check']:checked");
	if(checks==undefined || checks.length==0){
		alert("至少选择一条数据");
		return;
	}
	$(checks).each(function(){
		nstc.sf.delCurrRow(this)
	});
	setBillNum();
}
nstc.sf.delCurrRow = function(obj){
    var table = nstc.sf.findParent(obj, "TABLE");
    var tr = nstc.sf.findParent(obj, "TR");
    if(tr){
        if(arguments[1] === true){
            nstc.sf.changeFlag(obj,'delete');
            $(tr).hide();
        }else{
            table.deleteRow(tr.rowIndex);
        }
        //增加iframe自动刷新
        try{
            // 如果当前页面被iframe加载，自适应计算iframe的高度，跨域不适用。
            if(window.parent!=window) {
            var frameId = window.frameElement && window.frameElement.id || '';
                window.parent.smartForm_iFrameHeight(frameId);
            }
        }catch(e){}
    }
    //只匹配票据信息
    var regExp = /^gdt_\w*_bill$/;
    if(regExp.test(table.id)){
    	setBillNum();
    	changeConStartDate();
    	changeConEndDate();
    	countContractAmt();
    }
}
//清空账户
function emptyAccount() {
	var payNo = $('[id$="info.payNo"]');
	var payName = $('[id$="info.payName"]');
	var openBankName = $('[id$="info.openBankName"]');
	var openBankNo = $('[id$="info.openBankNo"]');
	payNo.val('');
	payName.val('');
	openBankName.val('');
	openBankNo.val('');
	showAsText (openBankName);
	showAsText (payName);
}
//获取日期最大值
function getMaxDate(name) {
	var dates = $('[id$="'+name+'"]:visible');
	var maxDate= '1970-01-01';
	for (var i = 0; i < dates.length; i++) {
		var date = dates[i].value;
		if (date != '' && DateCompare(date, maxDate) < 0) {
			maxDate = date;
		}
	}
	return maxDate == '1970-01-01' ? '' : maxDate;
}
//获取日期最大值
function getMinDate(name) {
	var dates = $('[id$="'+name+'"]:visible');
	var minDate= '2970-01-01';
	for (var i = 0; i < dates.length; i++) {
		var date = dates[i].value;
		if (date != '' && DateCompare(date, minDate) > 0) {
			minDate = date;
		}
	}
	return minDate == '2970-01-01' ? '' : minDate;
}