//间接融资-贸易融资》福费廷	
$(function(obj){
	/*var bussClass = $("select[id$=.bussClass]").val('CLMS03');*/
	var bussClass = $("select[id$='.bussClass']").attr('valu','CLMS03');
	var m = document.getElementById('m').value;
	if(m =='a'){
    	doChange(bussClass[0]);
    	//隐藏业务品种和分类,展示值
    	/*$("select[id$=.bussVariety]").val('CLMS27');*/
    	$("select[id$=.bussVariety]").attr('value','CLMS27');
	}
	var bussVariety = $("select[id$='.bussVariety']");
	var cltName = $("input[id$='.cltName']").val();
	var apply = $("input[id$='_form.applyId']").val();

	if(apply != undefined && apply != null && apply != ''){
		var clt = $("input[id$='_info.cltName']");
		doHiddenApply(clt);
		doHidden(bussClass,bussVariety);
		$('[id$="bill.sel"]').hide();
	}
	
	var m = document.getElementById('m').value;
	if(m=='e' || m == 'v' || m == ''){
		doHidden(bussClass,bussVariety);
	}
	
	var channel = $("input[id$='gdt_conForfaiting_form.channel']").val();
    //当channel字段不为GDEBIT时，将带入的数据置换为不可写
	if(isNotNull(channel) && channel != "GDEBIT"){
		var table = $("#gdt_conForfaiting_info");
		doReadOnly(table);
	}
});
//提交/保存  之前先进行校验
function saveCheck(){
	$("input").removeAttr("disabled");
	var bussVariety = $("select[id$=.bussVariety]").val();
	if(!doCheckBankIsNull(bussVariety)){
		alert("合作金融网点不存在！");
		return false;
	}
    var bill = $("table[id^=gdt][id$=_bill]").find("tbody tr:visible");
    if(bill.length == 0){
        alert("请选择信用证信息!");
        return false;
    }
    var tr = $(bill.get(0));
    var currencyNo = $('select[id$=_info.currencyNo]').val();
    if(currencyNo == undefined ){
        currencyNo = $('input[id$=_info.currencyNo]').val();
    }
    
    var rate=$('input[id$=_info.rate]');
    if(rate.val() !=''){
        if(100.0-parseFloat(rate.val().excludeNotNumericDot())<0){
            alert("利率值不能超过100");
            rate.val('');
            return false;
        }
    }
    
    var applyDate = $("input[id$=_info.applyDate]").val();
    var applyMsg = "申请日期";
    if(!applyDate){
    	applyDate = $("input[id$=_info.contractDate]").val();
        applyMsg = "签约日期";
    }
    var endDate = $("input[id$=_info.endDate]").val();
    var endMsg = "到期日期";
    
    //申请日 小于 开证日
    var startDate = tr.find('input[id$=_bill.startDate]').val();
    if(applyDate && !compareDate(startDate, applyDate, applyMsg + '不能早于开证日期')){
        return false;
    }
    
    //信用证有效期 小于合同到期日
    var dueDate = tr.find('input[id$=_bill.endDate]').val();
    if(!compareDate(dueDate, endDate, endMsg + '不能早于信用证有效期')){
        return false;
    }
    
    //校验申请日期小于合同开始日期
    var conStartDate = $('input[id$=_info.startDate]').val();
    if(applyDate && !compareDate(applyDate, conStartDate, '开始日不能小于申请日期')){
        return false;
    }
    
    //校验合同日期
//    var conStartDate = $('input[id$=_info.startDate]').val();
    if(!compareDate(startDate, endDate, '开始日不能晚于到日期')){
        return false;
    }
    
    //校验附件
    var files = $('input[id$=applyFiles_filetext]');
    if(!validateFileForamtBatch(files)){
        alert("系统不允许上传可执行格式的文件");
        return false;
    }
    
    //校验合同金额
    var conAmt = $('input[id$=_info.amount]').val();
    var billAmt = tr.find('input[id$=_bill.billAmount]').val();
    var conCur = $('select[id$=_info.currencyNo]').val();
    var billCur = tr.find('input[id$=_bill.currencyNo]').val();
    var data1 = "false";
    if((conCur && conCur != 'CNY') || (billCur && billCur != 'CNY')){
        $.ajax({
            type: 'POST',
            url: "GDEBIT@CheckConAmountBusiness.sf",
            async : false,
            data: {'conAmt':conAmt,'billAmt':billAmt,'conCur':conCur,'billCur':billCur},
            dataType: "text",
            success: function(data) {
                if(data != "true"){
                     alert("合同金额不能超过信用证开证金额");
                     return false;
                 }else{
                 	data1 = "true";
                 }
            },
            error:function(){
                alert("业务繁忙!");
            }
        }); 
    }else{
        if(conAmt.excludeNotNumericDot() - billAmt.excludeNotNumericDot() > 0){
        	alert("合同金额不能超过信用证开证金额");
            return false;
        }else{
        	data1 = "true";
        }
    }
    if(data1 =="true"){
    	return true;
    }
}
//选择信用证
function doSelICreditBill(){
    var cltNo = $("input[id$=_info.cltNo]").val();
    if(cltNo == undefined || cltNo == null || cltNo == ''){
        alert("请先选择单位")
        return ;
    }
    //客户
    var cltName = $("input[id$='_info.cltName']").val();
    //币种
    var currencyNo = $("select[id$='_info.currencyNo']").val();
    //申请日
    var applyDate = $("input[id$=_info.applyDate]").val();
    if(!applyDate){
    	applyDate = $("input[id$=_info.contractDate]").val();
    }
    //到期日
    var endDate = $("input[id$=_info.endDate]").val();
//    var bussVariety = $("select[id$=_info.bussVariety]").val();
//    if(bussVariety == undefined)bussVariety = $("input[id$=_info.bussVariety]").val();
    var url="GDEBIT@gdt_select_ILC.sf?m=v&cltNo="+cltNo+"&bussVariety=CLMS27&currencyNo="+currencyNo+"&applyDate="+applyDate+"&endDate="+endDate+"&cltName="+cltName;
    openwin(url, '选择信用证', 1000,600);
}
// 设置信用证母证
function setLCBill(result){
    var data = result;
    var pageCode = $("input[id='pageCode']").val();
    var checks= $('input[id$="_bill.billId"]');
    if(checks != undefined && checks.length != 0){
        $(checks).each(function(){
            if(this.value==undefined || this.value == null || this.value == '')return;
            nstc.sf.delCurrRow(this)
        });
    }
    
    var btnAdd = $("input[id$='_bill.add']")[0];
    var tr_row = smartForm_add(btnAdd);
    var tr = $(tr_row);
    
	var billNoHtml = "<INPUT id=" + pageCode + "_bill.billNo name=" + pageCode + "_bill.billNo value=" + data.billNo + " type=hidden>";
    var billIdHtml = "<INPUT id=" + pageCode + "_bill.billId name=" + pageCode + "_bill.billId value=" + data.billId + " type=hidden>";
    var billNoLink = "<a href='#' onclick='showLCbill(this)'>" + data.billNo + "</a>";
    tr.find("input[id$=_bill.billNo]").parent().parent().html(billNoLink + billIdHtml + billNoHtml);
    
    
    tr.find("input[id$='.billType']").val(data.billType);
    var creditTypeHtml  = tr.find("input[id$='.billType']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.billType]").parent().parent().html(data.billType + creditTypeHtml);
    
    tr.find("input[id$='.currencyNo']").val(data.currencyNo);
    var currencyNoHtml  = tr.find("input[id$='.currencyNo']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.currencyNo]").parent().parent().html(data.currencyName + currencyNoHtml);
    
    tr.find("input[id$='.billAmount']").val(data.billAmount);
    var billAmountHtml  = tr.find("input[id$='.billAmount']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.billAmount]").parent().parent().html("<span style ='text-align: right; font-weight: bold;'>"+FormatMoney(data.billAmount,2)+"</span>" + billAmountHtml);
    
    tr.find("input[id$='.startDate']").val(data.startDate);
    var createDateHtml  = tr.find("input[id$='.startDate']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.startDate]").parent().parent().html(data.startDate + createDateHtml);
    
    tr.find("input[id$='.accBankName']").val(data.accBankName);
    var bankNameHtml  = tr.find("input[id$='.accBankName']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.accBankName]").parent().parent().html(data.accBankName + bankNameHtml);
    
    tr.find("input[id$='.endDate']").val(data.endDate);
    var endDateHtml  = tr.find("input[id$='.endDate']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.endDate]").parent().parent().html(data.endDate + endDateHtml);
    
    tr.find("input[id$='.supplierName']").val(data.supplierName);
    var supplierNameHtml  = tr.find("input[id$='.supplierName']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.supplierName]").parent().parent().html(data.supplierName + supplierNameHtml);
    
    tr.find("input[id$='.forexType']").val(data.forexType);
    var forexTypeHtml  = tr.find("input[id$='.forexType']").parent()[0].outerHTML;
    tr.find("input[id$=_bill.forexType]").parent().parent().html(data.forexType + forexTypeHtml);
    
//    var isBackToBack = '是';
//    if(data.backToBack == '0'){
//    	isBackToBack = '否';
//    }
//    
//    tr.find("input[id$='.backToBack']").val(isBackToBack);
//    var backToBackHtml  = tr.find("input[id$='.backToBack']").parent()[0].outerHTML;
//    tr.find("input[id$=_bill.backToBack]").parent().parent().html(isBackToBack + backToBackHtml);
    
//    tr.find("input[id$='.nature']").val(data.nature);
//    var natureHtml  = tr.find("input[id$='.nature']").parent()[0].outerHTML;
//    tr.find("input[id$=_bill.nature]").parent().parent().html(data.nature + natureHtml);
}
//校验宽限期/多收期
function checkNumber(obj){
	if(obj.value!=''){
		obj.value =obj.value.replace(/\D/g,'');
		if(isNaN(obj.value)){
			alert("宽限期/多收期输入不合理，请重新输入");
			obj.value='';
			obj.focus();
			return false;
		}
	}
	smartPage_checkLength(obj,4);
}
