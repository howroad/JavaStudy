//放还款计划管理
$(function (){
	var bussVariety = $('input[id$=bussVariety]').val();
	if (bussVariety == 'CLMS26' || bussVariety == 'CLMS28') {
		$('input[id$=count]').hide();
	}
	//根据planType显示对应的域
	$("select[id$='.planType']").each(function() {
		setInfoByPlanType(this);
	});
	
	
	//计算天数
	$("input[id$='.startDate']").each(function() {
		setTermDay(this);
	});
	
	//还本付息计划
	$("input[id$='.executeState']").each(function(){
		if (this.value == '1') {//已执行
			var tr = $(this).parents("tr").first();
			//已执行的不能删除
			tr.find("input[id$='_check']").remove();
			//已执行的不能修改
			hideLedgerPlan(this);
		}
	});
	//计算剩余还本金额
	countLeftPlanAmount4All();
});

function doSave(obj) {
    if (!valiRePaymentAmount()) {
    	return;
    }
    
	var list = $("input[id='gdt_ledgerPlan4Repay_list.planId']");
	if (list.length < 2) {
		alert("请先新增还本付息计划再保存");
		return;
	}
	if(!checkIsExecuteDone()){
		return;
	}
	smartForm_doSave(obj);
}

function doSave4AS(obj) {
    if (!valiRePaymentAmount4AS()) {
    	return;
    }
    
	var list = $("input[id='gdt_ledgerPlan4AS_list.planId']");
	if (list.length < 2) {
		alert("请先新增还本付息计划再保存");
		return;
	}
	smartForm_doSave(obj);
}

//删除
function delLedgerPlan(obj, flag) {
	var bussVariety = $("[id$='bussVariety']").val();
	var planList;
	if (bussVariety=="CLMS28"){
		planList = $("input[id='gdt_ledgerPlan4AS_list._check']:checked");
	}else{
		planList = $("input[id='gdt_ledgerPlan4Repay_list._check']:checked");
	}
	if (planList.length < 1) {
		alert("至少勾选一条数据");
		return;
	}
	smartForm_doDelete(obj);
}
function smartForm_addNew(obj) {
	try {
		var names = obj.name.split('.');
		var unitname = names[0];
		return nstc.sf.addRow(unitname, "tableCopy_" + unitname);
	} catch (e) {

	}
	try{
		var frameId = window.frameElement && window.frameElement.id || '';
		if(window.parent != window)
			window.parent.smartForm_iFrameHeight(frameId);
	}catch(e){}
}
//修改还本方式
function changePlayType(obj) {
	var planType = obj.value;//1还本，2付息，5还款
	var tr = $(obj).parents("tr").first();
	var code = '';//编号编码
	var planNo = '';//计划ID
	if (planType == '2') {//付息
		code = 'FX';
		planNo = tr.find("input[id$='.planNo_FX']").val();
	} else {//1还本，5还款
		code = 'HB';
		planNo = tr.find("input[id$='.planNo_HB']").val();
	}
	if (planNo == '') {
		planNo = querySerialNumber(code);//计划ID
	}
	if (planType == '2') {//付息
		tr.find("input[id$='.planNo_FX']").val(planNo);
	} else {//1还本，5还款
		tr.find("input[id$='.planNo_HB']").val(planNo);
	}
	
	setInfoByPlanType(obj);
	
	setInfo4InputAndSpan(tr, 'planNo', planNo, planNo);
	
	//计算剩余还本金额
	countLeftPlanAmount4All();
}

function setInfoByPlanType(obj) {
	var tr = $(obj).parents("tr").first();
	var planType = tr.find("select[id$='.planType']").val();;//1还本，2付息
	if (planType == '2'){//付息
		tr.find("input[id$='.startDate']").attr('validate', 'require|').show();
		tr.find("input[id$='.endDate']").attr('validate', 'require|').show();
		tr.find("input[id$='.interest']").show();//.attr('validate', 'require|')
		tr.find("input[id$='.rate']").show();//.attr('validate', 'require|')
	} else {//1还本，5还款
		tr.find("input[id$='.startDate']").val('').removeAttr('validate').hide();
		tr.find("input[id$='.endDate']").val('').removeAttr('validate').hide();
		setInfo4InputAndSpan(tr, 'dayCount', '', '');
		tr.find("input[id$='.interest']").val('').removeAttr('validate').hide();
		tr.find("input[id$='.rate']").val('').removeAttr('validate').hide();
	}
}

//计算计息天数
function setTermDay(obj) {
	var tr = $(obj).parents("tr").first();
	var startDate = tr.find("input[id$='.startDate']").val();
	var endDate = tr.find("input[id$='.endDate']").val();
	var dayCount = '';
	if(startDate != null && endDate != null ){
		if(!compareDate(startDate, endDate, '开始日不能晚于到期日')){
			tr.find("input[id$='.endDate']").val('');
			setInfo4InputAndSpan(tr, 'dayCount', '', '');
			return false;
		}
		if (startDate != '' && endDate != '') {
			dayCount = dateDiff(startDate, endDate) + 1;
		}
	}
	setInfo4InputAndSpan(tr, 'dayCount', dayCount, dayCount);
	return true;
}

/**
 * 计算利息
 * @param obj
 */
function calInterest(obj){
	var tr = $(obj).parents('tr').first();
	var interest = tr.find("input[id$='interest']").val();//计息金额
	if(interest != null && interest != '') {
		if(parseFloat(interest.excludeNotNumericDot()) < 0){
			alert("计息金额必须大于0");
			interest.val('');
			return;
		}
		
	}
	if(checkPlanRate(obj)){
		//利息=金额*（计息截止日-计息开始日）*利率/365(取计息基数的值)
		var interestAccDay = $("input[id='gdt_ledgerPlan4Repay_info.interestAccDay']").val();
		if(interestAccDay == null || interestAccDay == ''){
			interestAccDay = "360";
		}
		var startDate = tr.find('input[id$=".startDate"]').val();
		var endDate = tr.find('input[id$=".endDate"]').val();
		var rate = tr.find('input[id$=".rate"]').val().excludeNotNumericDot();
		var planAmountObj = tr.find('input[id$=".planAmount"]');//利息
		var interest = tr.find("input[id$='.interest']").val().excludeNotNumericDot();//计息金额

		//校验日期
		if (!setTermDay(obj)) {
			return false;
		}
		
		if(startDate != null && endDate != null && startDate != '' && endDate != '' && rate != '' && interest != ''){
			var planAmountVal = interest * (dateDiff(startDate, endDate)+1) * rate / interestAccDay / 100;
			if(planAmountVal <= 0.001){
				planAmountObj.val('0.00');
			} else {
				planAmountObj.val(FormatMoney(planAmountVal, 2));
			}
		}/*else{
			planAmountObj.val('');
		}*/
	}
}

/**
 * 校验利率
 * @param obj
 * @returns {Boolean}
 */
function checkPlanRate(obj){
	var rate = $(obj).parents('tr').first().find("input[id$='rate']");
	var rateVal = rate.val().excludeNotNumericDot()
	if(rateVal != undefined && rateVal != ''){
		if(100.0 - parseFloat(rateVal) < 0){
			alert("利率值不能超过100");
			rate.val('');
			return false;
		} else if(parseFloat(rateVal) <= 0){
			alert("利率值必须大于0");
			rate.val('');
			return false;
		}
	}
	return true;
}

//不可编辑
function hideInput(tr, id, type) {
	var obj = tr.find("[id$='" + id + "']");
	var value;
	var html;
	if (type == 'select') {
		value = obj.find(" option:selected").text();
		html = obj.html();
	} else {
		value = obj.val();
	}
	obj.hide().parent().html(value).append(obj);
	
	if (type == 'select') {
		obj.html(html);
	}
}

//隐藏还本付息计划
function hideLedgerPlan(obj) {
	if (obj.value != '1') {//1已执行
		return true;
	}
	var ids = ['planType', 'actDate', 'planAmount', 'interest', 'startDate', 'endDate', 'rate', 'memo'];
	var types = ['select', '', '', '', '', '', '', ''];
	var tr = $(obj).parents("tr").first();
	for (var i = 0; i < ids.length; i++) {
		hideInput(tr, ids[i], types[i]);
	}
	/*$("input[id='gdt_ledgerPlan4Repay_list.planId']").each(function(){
	});*/
}
//计算剩余还本金额
function countLeftPlanAmount4All(obj) {
	if (obj != undefined) {
		var list = $("input[id='gdt_ledgerPlan4Repay_drawings.dueDate']");
		var dueDate = "";//到期日
		for(var i = 0;i < list.length; i++) {
			dueDate = list.eq(i).val();
			if (dueDate != '') {
				break;
			}
		}
		var tr = $(obj).parents("tr").first();
		var actDate = tr.find("input[id$='.actDate']").val();//还本付息日期
		var planType = tr.find("[id$='.planType']").val();//发生额类型
		if (actDate != '' && dueDate != '') {
			if (dateDiff(actDate, dueDate) < 0){
				tr.find("input[id$='.actDate']").val('');
				alert("日期不能大于提款到期日");
				return;
			}
		}
		if (planType != '1') {//1还本
			return;
		}
	} 
	
	//计算剩余还本金额
	$("input[id='gdt_ledgerPlan4Repay_list.planId']").each(function(){
		countLeftPlanAmount(this);
	});
}
function countLeftPlanAmount4All4AS(obj) {
	if (obj != undefined) {
		var list = $("input[id='gdt_ledgerPlan4AS_drawings.dueDate']");
		var dueDate = "";//到期日
		for(var i = 0;i < list.length; i++) {
			dueDate = list.eq(i).val();
			if (dueDate != '') {
				break;
			}
		}
		var tr = $(obj).parents("tr").first();
		var actDate = tr.find("input[id$='.actDate']").val();//还本付息日期
		var planType = tr.find("[id$='.planType']").val();//发生额类型
		if (actDate != '' && dueDate != '') {
			if (dateDiff(actDate, dueDate) < 0){
				tr.find("input[id$='.actDate']").val('');
				alert("日期不能大于提款到期日");
				return;
			}
		}
		if (planType != '1') {//1还本
			return;
		}
	} 
	
	//计算剩余还本金额
	$("input[id='gdt_ledgerPlan4AS_list.planId']").each(function(){
		countLeftPlanAmount4AS(this);
	});
}
function countLeftPlanAmount(obj) {
	var tr = $(obj).parents("tr").first();
	var leftPlanAmountObj = tr.find("input[id$='leftPlanAmount']");
	var fetchAmount;//提款金额
	var fetchAmountList = $("input[id='gdt_ledgerPlan4Repay_drawings.fetchAmount']");
	for(var i = 0; i < fetchAmountList.length; i++) {
		fetchAmount = fetchAmountList.eq(i).val();
		if (fetchAmount != '') {
			fetchAmount = fetchAmountList.eq(i).val().excludeNotNumericDot();
			break;
		}
	}

	var leftPlanAmount = fetchAmount;//剩余还款金额
	var planType = tr.find("select[id$='planType']").val();
	var actDate = tr.find("input[id$='actDate']").val();
	var planAmount = tr.find("input[id$='planAmount']").val();
	if(planType != '1' || planAmount == '') {//1:还本
		leftPlanAmountObj.parent().html('').append(leftPlanAmountObj);
		return;
	}
	
	var list = $("input[id='gdt_ledgerPlan4Repay_list.planId']");//:visible
	for(var i = 0; i < list.length; i++) {
		var tr_i = list.eq(i).parents("tr").first();
		var planType_i = tr_i.find("select[id$='planType']").val();
		var actDate_i = tr_i.find("input[id$='actDate']").val();
		var planAmount_i = tr_i.find("input[id$='planAmount']").val();
		if (actDate_i == '' || planAmount_i == '' || planType_i != '1') {//1:还本
			continue;
		}
		if (actDate >= actDate_i) {
			var planAmount_i = tr_i.find("input[id$='planAmount']").val().excludeNotNumericDot();
			leftPlanAmount = FloatSub(leftPlanAmount, planAmount_i);
		}
	}
	
	leftPlanAmountObj.parent().html(FormatMoney(leftPlanAmount, 2)).append(leftPlanAmountObj);
}
function countLeftPlanAmount4AS(obj) {
	var tr = $(obj).parents("tr").first();
	var leftPlanAmountObj = tr.find("input[id$='leftPlanAmount']");
	var fetchAmount;//提款金额
	var fetchAmountList = $("input[id='gdt_ledgerPlan4AS_drawings.fetchAmount']");


	var productId = tr.find("[id$='productId']").val();
		for(var i = 0; i < fetchAmountList.length; i++) {
			fetchAmount = fetchAmountList.eq(i).val();
			var d_tr = $( fetchAmountList.eq(i)).parents("tr").first();
			var d_productId= d_tr.find("[id$='productId']").val();
			if (fetchAmount != ''&&productId==d_productId) {
				fetchAmount = fetchAmountList.eq(i).val().excludeNotNumericDot();
				break;
			}
		}
	
		var leftPlanAmount = fetchAmount;//剩余还款金额
		var planType = tr.find("select[id$='planType']").val();
		var actDate = tr.find("input[id$='actDate']").val();
		var planAmount = tr.find("input[id$='planAmount']").val();
		if(planType != '1' || planAmount == '') {//1:还本
			leftPlanAmountObj.parent().html('').append(leftPlanAmountObj);
			return;
		}
		
		var list = $("input[id='gdt_ledgerPlan4AS_list.planId']");//:visible
		for(var i = 0; i < list.length; i++) {
			var tr_i = list.eq(i).parents("tr").first();
			var planType_i = tr_i.find("select[id$='planType']").val();
			var actDate_i = tr_i.find("input[id$='actDate']").val();
			var planAmount_i = tr_i.find("input[id$='planAmount']").val();
			var i_productId= tr_i.find("[id$='productId']").val();
			if (actDate_i == '' || planAmount_i == '' || planType_i != '1'||i_productId!=productId) {//1:还本
				continue;
			}
			if (actDate >= actDate_i) {
				var planAmount_i = tr_i.find("input[id$='planAmount']").val().excludeNotNumericDot();
				leftPlanAmount = FloatSub(leftPlanAmount, planAmount_i);
			}
		}
		
		leftPlanAmountObj.parent().html(FormatMoney(leftPlanAmount, 2)).append(leftPlanAmountObj);

}
//点击确定操作
function smartForm_confirm_true(){
	var objbut = top.Layer.getWin().document.getElementById("gdt_ledgerPlan_conInfo.refresh");
	if(objbut){
		smartForm_doRefresh(objbut);
		windowClose();
	}
}
function smartForm_confirm(msg) {
	alert(msg);
	smartForm_confirm_true();
}
function doCalculate(obj) {
	if (!valiRePaymentAmount()) {
		return;
	}
	smartForm_doSave(obj);
}
/**
 * 校验 还本金额不能大于提款金额
 * @returns {Boolean}
 */
function valiRePaymentAmount() {
	var fetchAmount;//提款金额
	var fetchAmountList = $("input[id='gdt_ledgerPlan4Repay_drawings.fetchAmount']");
	for(var i = 0; i < fetchAmountList.length; i++) {
		fetchAmount = fetchAmountList.eq(i).val();
		if (fetchAmount != '') {
			fetchAmount = fetchAmountList.eq(i).val().excludeNotNumericDot();
			break;
		}
	}
	
	var list = $("input[id='gdt_ledgerPlan4Repay_list.planId']");//:visible
	var totalRepayAmt = 0;
	
	var maxInterestDate = $("input[id$='maxInterestDate']").val();
	for(var i = 0; i < list.length; i++) {
		var tr_i = list.eq(i).parents("tr").first();
		var actDate_i = tr_i.find("input[id$='actDate']").val();
		var planType_i = tr_i.find("select[id$='planType']").val();
		var executeState_i = tr_i.find("input[id$='executeState']").val();
//		if (maxInterestDate != null && maxInterestDate != '' && executeState_i == '0' && maxInterestDate != undefined) {
//			if (actDate_i != '' && planType_i == '2' && dateDiff(maxInterestDate, actDate_i) <= 0) {
//				alert("目前已执行的最近一次的付息日期为：" + maxInterestDate + "，录入的日期应大于该日期");
//				return false;
//			}
//		}
		
		var planAmount_i = tr_i.find("input[id$='planAmount']").val();
		if (actDate_i == '' || planAmount_i == '' || planType_i != '1') {//1:还本
			continue;
		}
		var planAmount_i = tr_i.find("input[id$='planAmount']").val().excludeNotNumericDot();
		totalRepayAmt = accadd(totalRepayAmt, planAmount_i);
	}
	if (FloatSub(totalRepayAmt, fetchAmount) > 0) {
		alert("还本金额总和不能大于提款金额");
		return false;
	}
	return true;
}
function valiRePaymentAmount4AS() {
	//校验改为后台校验
	/*var fetchAmount;//提款金额
	var fetchAmountList = $("input[id='gdt_ledgerPlan4AS_drawings.fetchAmount']");
	for(var i = 0; i < fetchAmountList.length; i++) {
		fetchAmount = fetchAmountList.eq(i).val();
		if (fetchAmount != '') {
			fetchAmount = fetchAmountList.eq(i).val().excludeNotNumericDot();
			break;
		}
	}
	
	var list = $("input[id='gdt_ledgerPlan4AS_list.planId']");//:visible
	var totalRepayAmt = 0;
	
	var maxInterestDate = $("input[id$='maxInterestDate']").val();
	for(var i = 0; i < list.length; i++) {
		var tr_i = list.eq(i).parents("tr").first();
		var actDate_i = tr_i.find("input[id$='actDate']").val();
		var planType_i = tr_i.find("select[id$='planType']").val();
		var executeState_i = tr_i.find("input[id$='executeState']").val();
//		if (maxInterestDate != null && maxInterestDate != '' && executeState_i == '0' && maxInterestDate != undefined) {
//			if (actDate_i != '' && planType_i == '2' && dateDiff(maxInterestDate, actDate_i) <= 0) {
//				alert("目前已执行的最近一次的付息日期为：" + maxInterestDate + "，录入的日期应大于该日期");
//				return false;
//			}
//		}
		
		var planAmount_i = tr_i.find("input[id$='planAmount']").val();
		if (actDate_i == '' || planAmount_i == '' || planType_i != '1') {//1:还本
			continue;
		}
		var planAmount_i = tr_i.find("input[id$='planAmount']").val().excludeNotNumericDot();
		totalRepayAmt = accadd(totalRepayAmt, planAmount_i);
	}
	if (FloatSub(totalRepayAmt, fetchAmount) > 0) {
		alert("还本金额总和不能大于提款金额");
		return false;
	}*/
	return true;
}
function setBondCodeAndRate(obj){
	var tr = nstc.sf.findParent(obj, "tr");
	var productId = $(tr).find("[id$='productId']").val();
	
	$("[id='gdt_ledgerPlan4AS_drawings.productId']").each(function(){
		var tr2 = nstc.sf.findParent(this, "tr");
		var productIdW = $(this).val();
		if (productIdW == productId) {
			var bondCodeW = $(tr2).find("[id$='bondCode']").val();
			var rateW = $(tr2).find("[id$='rate']").val();
			var bondCode = $(tr).find("[id$='bondCode']");
			var rate = $(tr).find("[id$='rate']");
			$(bondCode).val(bondCodeW);
			/*$(rate).val(FormatMoney(rateW,6));*/
			/*break;*/
		}
	});
}
function checkIsExecuteDone(){
	var tr = $("[id$='tableCopy_gdt_ledgerPlan4Repay_list']:visible");
	var startDate_new = $(tr).find("[id$='startDate']").val();
	var endDate_new = $(tr).find("[id$='endDate']").val();
	var actDate_new = $(tr).find("[id$='actDate']").val();
	var planNo_new = $(tr).find("[id$='planNo']").val();
	if(startDate_new!=undefined&&startDate_new!=''){
		var planNos= $("[id$='_list.planNo']");
		var endDates= $("[id$='_list.endDate']");
		var endDate_old = "";
		for(var i=0;i<planNos.length;i++){
			var planNo = $(planNos[i]).val();
			if(planNo!=""&&planNo!=planNo_new){
				endDate_old = $(endDates[i]).val();
			}
		}
		if(dateDiff(startDate_new, endDate_old) > 0){
			for(var i=0;i<planNos.length;i++){
				var planNo = $(planNos[i]).val();
				if(planNo!=""&&planNo!=planNo_new){
					var start = $(planNos[i]).closest("tr").find("[id$='startDate']").val();
					var end = $(planNos[i]).closest("tr").find("[id$='endDate']").val();
					var act = $(planNos[i]).closest("tr").find("[id$='actDate']").val();
					var executeState = $(planNos[i]).closest("tr").find("[id$='executeState']").val();
					if(start==startDate_new&&end==endDate_new&&act==actDate_new){
						if(executeState=='0'){
							alert("存在未执行的付息计划，保存失败");
							return false;
						}
					}
				}
			}
		}else{
			return true;
		}
	}
	return true;
}
