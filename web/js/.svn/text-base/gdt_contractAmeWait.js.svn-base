/**
 * 合同修正页面
 */
$(function(){
	/*var approveNote = $("input[id$='approveNote']");
	for(var i = 0;i < approveNote.length;i++){
		if($(approveNote[i]).val() != null && $(approveNote[i]).val() != '' ){
			$(approveNote[i]).parent().parent().parent().css("background-color","pink");
		}
	}*/
	var rowList = $("input[id$='amount']");
	for(var i = 0;i < rowList.length;i++){
		/*if($(rowList[i]).val() != null && $(rowList[i]).val() != '' ){
			$(rowList[i]).parent().parent().parent().css("background-color","pink");
		}*/
		var tr = nstc.sf.findParent(rowList[i], "TR");
		var rejectReason = $(tr).find("[id$=.approveNoteHiden]").val();
		if (rejectReason != null && rejectReason != '') {
			$(tr).css("background-color", "#FFC0CB");
		}
	}
})

//展示合同详情
function showContract(obj){
	var tr = nstc.sf.findParent(obj, 'tr');
	var bussVariety = $(tr).find('input[id$=.bussVariety]').val();
	var contractId = $(tr).find('input[id$=.contractId]').val();
//	doSelContract(bussVariety,null,null,contractId,"v")
}


//查询操作
function doQuery(obj){
	var minAmount = $('input[id$=.minAmount]').val();
	var maxAmount = $('input[id$=.maxAmount]').val();
	if(!compareAmount(minAmount, maxAmount, '合同金额范围不合理')){
		return;
	} 
	
//	var sFmDate=$('input[id$="minDate"]').val();
//	var eFmDate=$('input[id$="maxDate"]').val();
//	if(compareDate(sFmDate,eFmDate,'日期范围不合理')){
//		smartForm_doRefresh(obj);
//	}
	smartForm_doRefresh(obj)
}

function doSumbit(obj){
	var checkObj = $("[id$=._check]:visible");
	var checkNum = getCheckNum();
	if (checkNum == 0) {
		alert("至少选择一条记录！");
		return;
	}
	//add by ly start 
	if(!checkGuaOnSubmit(checkObj)){
		alert("担保信息不能为空！");
		return;
	}
	//add by ly end
	smartForm_doDelete(obj);
}
//add by ly start 提交到工作流之前，校验担保是否占用，是否需要补录担保信息
function checkGuaOnSubmit(obj){
	var checkObj = new Array();
	checkObj = obj;
	var result = true;
	for ( var i = 0; i < checkObj.length; i++) {
		if (checkObj[i].checked) {
			var tr = $(checkObj[i]).closest("tr");
			var isTakeGuarantee = tr.find("[id$='isTakeGuarantee']").val();
			if(isTakeGuarantee == 1){//1占担保 0不占
				var fmId = tr.find("[id$='_list.fmId']").val();
				$.ajax({
					type: 'POST',
					  url: "GDEBIT@CheckGuaranteeContractNoExistBusiness.sf",
					  async : false,
					  data: {"fmId":fmId},
					  success: function(data) {
						 if(data != "true"){
							 result = false;
						 }
					  }
				});
			}
			if(result == false){
				break;
			}
		}
	}
	return result;
}
//add by ly end 
//删除按钮
function doDeleteAme(obj){
	var checkNum = getCheckNum();
	if (checkNum == 0) {
		alert("至少选择一条记录！");
		return;
	}
	if(confirm("确认删除？")){
		//smartForm_doSave(obj);
		var form = nstc.sf.findParent(obj, "FORM");
		form.action = $('#appNo').val() + '@' + obj.id + ".sf";
		form.submit();
	}
}

//全选
function checkAll(obj){
	smartForm_all_checkbox(obj,'gdt_contractAmeWait_list._check');
	getCheckSize();
}
//获取选中的行
function getCheckNum(){
	var checkObj = $("[id$=._check]:visible");
	var checkNum = 0;
	for ( var i = 0; i < checkObj.length; i++) {
		if (checkObj[i].checked) {
			checkNum++;
		}
	}
	return checkNum;
}
//选择某一个
function checkRec(obj){
	nstc.sf.clickCheckbox(obj);
	getCheckSize();
}
function getCheckSize(){
	var selectRecords = $("[id$=selectRecords]").val();
	var checkNum=getCheckNum();
	var selectRecordsHtml  = '<input id="selectRecords" name="selectRecords" type="hidden" value="'+selectRecords+'"/>'
	$("[id$=selectRecords]").parent().html("共计"+selectRecords+"笔，已选"+checkNum+"笔。"+selectRecordsHtml);
}
 
//查看操作
function doLookAme(obj,wait){
	var tr = nstc.sf.findParent(obj, 'tr');
	var fmId = $(tr).find('input[id$=.fmId]').val();
	var bussVariety = $(tr).find('input[id$=.bussVariety]').val();
	var contractId = $(tr).find('input[id$=.contractId]').val();
	
	var url = "GDEBIT@gdt_contractAmeLook.sf?m=v&fmId="+fmId+"&wait="+wait+"&contractId="+contractId;
	openwin(url, '融资变更详情', 1200, 500);
}
//修改操作
function doUpdateAme(obj){
	var tr = nstc.sf.findParent(obj, 'tr');
	var fmId = $(tr).find('input[id$=.fmId]').val();
	var contractId = $(tr).find('input[id$=.contractId]').val();
	//校验是否在工作流中
	var result = validateInFlow('GDEBIT_FM003',contractId);
	if(result != '' && result != null && result != undefined){
		alert(result);
		return;
	}
	var bussVariety = $(tr).find('input[id$=.bussVariety]').val();
	doSelAmendment(bussVariety,fmId,contractId,"e");
}
//返回操作
function doReturn(){
	location.href = "GDEBIT@gdt_contractAmendment.sf?m=v";
}